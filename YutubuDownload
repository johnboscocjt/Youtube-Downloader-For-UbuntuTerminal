#!/usr/bin/env bash
# YutubuDownload - Tanzania-Optimized YouTube Downloader for Ubuntu Terminal
# Author: Johnbosco | Updated: February 08, 2026
# GitHub: https://github.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal

set -euo pipefail

# === COLOR DEFINITIONS ===
RESET="\033[0m"
BLACK="\033[30m"
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
MAGENTA="\033[35m"
CYAN="\033[36m"
WHITE="\033[37m"
BRIGHT_RED="\033[91m"
BRIGHT_GREEN="\033[92m"
BRIGHT_YELLOW="\033[93m"
BRIGHT_BLUE="\033[94m"
BRIGHT_MAGENTA="\033[95m"
BRIGHT_CYAN="\033[96m"
BRIGHT_WHITE="\033[97m"
ORANGE="\033[38;5;214m"
PINK="\033[38;5;206m"
LIME="\033[38;5;46m"
SKY_BLUE="\033[38;5;39m"
HOT_PINK="\033[38;5;196m"

# === HELPER FUNCTION FOR PADDED COLORED OUTPUT ===
print_padded() {
    local label="$1"
    local colored_text="$2"
    local total_width=78  # Box width minus 2 for borders
   
    # Remove color codes to calculate actual text length
    local plain_text=$(echo -e "$colored_text" | sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g")
    local text_length=${#plain_text}
    local label_length=${#label}
    local total_length=$((label_length + text_length))
    local padding=$((total_width - total_length))
   
    printf "${BRIGHT_GREEN}â•‘${RESET} ${CYAN}%s${RESET} %s%*s ${BRIGHT_GREEN}â•‘${RESET}\n" "$label" "$colored_text" "$padding" ""
}

# === ANIMATED FEEDBACK FUNCTIONS ===
print_loading() {
    local msg="$1"
    echo -ne "${SKY_BLUE}$msg${RESET}"
    for _ in {1..5}; do
        echo -ne "."
        sleep 0.3
    done
    echo -e " ${BRIGHT_GREEN}âœ…${RESET}"
}

print_error() {
    local msg="$1"
    echo -ne "${HOT_PINK}$msg${RESET}"
    for _ in {1..3}; do
        echo -ne " â—"
        sleep 0.2
    done
    echo -e " ${RED}âŒ${RESET}"
}

# Function to extract YouTube video ID from URL
extract_video_id() {
    local url="$1"
    local video_id=""
    
    if [[ "$url" =~ (?:v=|youtu\.be/)([^&?/]{11}) ]]; then
        video_id="${BASH_REMATCH[1]}"
    elif [[ "$url" =~ youtube\.com/embed/([^/?&]{11}) ]]; then
        video_id="${BASH_REMATCH[1]}"
    elif [[ "$url" =~ youtube\.com/watch\?.*v=([^&]{11}) ]]; then
        video_id="${BASH_REMATCH[1]}"
    fi
    
    echo "$video_id"
}

# Function to process archived videos for playlist - FIXED VERSION
process_playlist_archive() {
    local url="$1"
    local archive_file="$2"
    
    echo -e "${SKY_BLUE}ğŸ”„ Checking playlist for archived videos...${RESET}"
    
    # First, try to get playlist ID from URL
    local playlist_id=""
    if [[ "$url" =~ list=([^&]+) ]]; then
        playlist_id="${BASH_REMATCH[1]}"
    fi
    
    if [[ -z "$playlist_id" ]]; then
        echo -e "${ORANGE}âš ï¸  Could not extract playlist ID from URL.${RESET}"
        echo -e "${CYAN}Will check archive during download process.${RESET}"
        return
    fi
    
    echo -e "${CYAN}Playlist ID: $playlist_id${RESET}"
    
    # Create a temporary file for video IDs
    local temp_file=$(mktemp)
    
    # Try to fetch playlist with SIMULATE mode (much faster)
    echo -e "${CYAN}Fetching playlist information...${RESET}"
    
    # Method 1: Use --flat-playlist with --print (fastest)
    timeout 30 yt-dlp \
        --cookies-from-browser chrome \
        --yes-playlist \
        --flat-playlist \
        --print "%(id)s" \
        --quiet \
        --no-warnings \
        --playlist-end 100 \
        "https://www.youtube.com/playlist?list=$playlist_id" > "$temp_file" 2>/dev/null
    
    if [[ ! -s "$temp_file" ]]; then
        # Method 2: Try with the original URL
        timeout 25 yt-dlp \
            --cookies-from-browser chrome \
            --yes-playlist \
            --flat-playlist \
            --print "%(id)s" \
            --quiet \
            --no-warnings \
            --playlist-end 100 \
            "$url" > "$temp_file" 2>/dev/null
    fi
    
    # Read the video IDs
    local all_video_ids=""
    if [[ -s "$temp_file" ]]; then
        all_video_ids=$(cat "$temp_file" | head -n 100)
        echo -e "${LIME}âœ… Successfully fetched playlist${RESET}"
    else
        # Method 3: Last resort - try without cookies
        echo -e "${ORANGE}âš ï¸  Trying without authentication...${RESET}"
        timeout 20 yt-dlp \
            --yes-playlist \
            --flat-playlist \
            --print "%(id)s" \
            --quiet \
            --no-warnings \
            --playlist-end 50 \
            "https://www.youtube.com/playlist?list=$playlist_id" > "$temp_file" 2>/dev/null
        
        if [[ -s "$temp_file" ]]; then
            all_video_ids=$(cat "$temp_file" | head -n 50)
            echo -e "${LIME}âœ… Fetched playlist without authentication${RESET}"
        fi
    fi
    
    # Clean up temp file
    rm -f "$temp_file" 2>/dev/null || true
    
    if [[ -z "$all_video_ids" ]]; then
        echo -e "${ORANGE}âš ï¸  Could not fetch playlist info.${RESET}"
        echo -e "${CYAN}Will show archive options during download instead.${RESET}"
        return
    fi
    
    local video_count
    video_count=$(echo "$all_video_ids" | wc -l)
    echo -e "${LIME}âœ… Found $video_count videos in playlist${RESET}"
    
    # Check archive file
    if [[ ! -f "$archive_file" ]] || [[ ! -s "$archive_file" ]]; then
        echo -e "${BRIGHT_GREEN}âœ… Archive file is empty. All videos will be downloaded.${RESET}"
        return
    fi
    
    # Check which videos are in archive
    local archived_videos=()
    local archived_count=0
    
    echo -e "${CYAN}Checking archive...${RESET}"
    
    # Read archive into array
    mapfile -t archive_array < "$archive_file" 2>/dev/null || true
    
    # Check each video
    while IFS= read -r video_id; do
        [[ -z "$video_id" ]] && continue
        
        for archived_id in "${archive_array[@]}"; do
            if [[ "$archived_id" == "$video_id" ]]; then
                archived_videos+=("$video_id")
                ((archived_count++))
                break
            fi
        done
    done <<< "$all_video_ids"
    
    if [[ $archived_count -eq 0 ]]; then
        echo -e "${BRIGHT_GREEN}âœ… No archived videos found. All $video_count videos will be downloaded.${RESET}"
        return
    fi
    
    echo ""
    echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${BRIGHT_CYAN}ğŸ“‹ ARCHIVED VIDEOS FOUND: $archived_count/$video_count${RESET}"
    echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    
    # Process each archived video
    local videos_to_remove=()
    local videos_to_keep=()
    local index=1
    
    for video_id in "${archived_videos[@]}"; do
        echo -e "${BRIGHT_BLUE}Video $index of $archived_count:${RESET}"
        echo -e "  ${CYAN}Video ID:${RESET} $video_id"
        echo -e "  ${CYAN}URL:${RESET} https://youtu.be/$video_id"
        echo ""
        echo -e "  ${CYAN}Options:${RESET}"
        echo -e "    ${BRIGHT_GREEN}r${RESET} = RE-DOWNLOAD (remove from archive)"
        echo -e "    ${BRIGHT_BLUE}s${RESET} = SKIP (keep in archive)"
        echo -e "    ${BRIGHT_YELLOW}a${RESET} = Apply to ALL remaining videos"
        echo -e "    ${BRIGHT_RED}x${RESET} = Skip ALL remaining (keep all in archive)"
        echo -n -e "  ${BRIGHT_CYAN}Your choice (r/s/a/x) [default=s]: ${RESET}"
        
        read -r choice
        choice=$(echo "${choice:-s}" | tr '[:upper:]' '[:lower:]')
        
        case "$choice" in
            r)
                videos_to_remove+=("$video_id")
                echo -e "  ${LIME}âœ… Will re-download: $video_id${RESET}"
                ;;
            a)
                # Apply to all remaining
                echo -n -e "  ${BRIGHT_CYAN}Apply what to ALL remaining? (r/s): ${RESET}"
                read -r bulk_choice
                bulk_choice=$(echo "${bulk_choice:-s}" | tr '[:upper:]' '[:lower:]')
                
                if [[ "$bulk_choice" == "r" ]]; then
                    for ((j=index-1; j<archived_count; j++)); do
                        videos_to_remove+=("${archived_videos[$j]}")
                    done
                    echo -e "  ${LIME}âœ… Will re-download ALL remaining videos${RESET}"
                else
                    for ((j=index-1; j<archived_count; j++)); do
                        videos_to_keep+=("${archived_videos[$j]}")
                    done
                    echo -e "  ${LIME}âœ… Will SKIP ALL remaining videos${RESET}"
                fi
                break
                ;;
            x)
                # Skip all remaining
                for ((j=index-1; j<archived_count; j++)); do
                    videos_to_keep+=("${archived_videos[$j]}")
                done
                echo -e "  ${LIME}âœ… Will SKIP ALL remaining videos${RESET}"
                break
                ;;
            *)
                videos_to_keep+=("$video_id")
                echo -e "  ${LIME}âœ… Will skip: $video_id${RESET}"
                ;;
        esac
        
        echo ""
        ((index++))
    done
    
    # Update archive file
    if [[ ${#videos_to_remove[@]} -gt 0 ]]; then
        echo -e "\n${SKY_BLUE}ğŸ”„ Updating archive file...${RESET}"
        
        # Create temp archive without removed videos
        local temp_archive="${archive_file}.temp"
        
        # Start with empty file
        > "$temp_archive"
        
        # Keep all videos except those marked for removal
        for archived_id in "${archive_array[@]}"; do
            local keep_this=true
            for remove_id in "${videos_to_remove[@]}"; do
                if [[ "$archived_id" == "$remove_id" ]]; then
                    keep_this=false
                    break
                fi
            done
            
            if [[ "$keep_this" == "true" ]]; then
                echo "$archived_id" >> "$temp_archive"
            fi
        done
        
        mv "$temp_archive" "$archive_file" 2>/dev/null || true
        echo -e "${BRIGHT_GREEN}âœ… Removed ${#videos_to_remove[@]} videos from archive${RESET}"
    fi
    
    echo -e "\n${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${BRIGHT_CYAN}ğŸ“Š DOWNLOAD SUMMARY${RESET}"
    echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${CYAN}Total videos in playlist:${RESET} $video_count"
    echo -e "${CYAN}Will download:${RESET} $((video_count - ${#videos_to_keep[@]}))"
    echo -e "${CYAN}Will skip:${RESET} ${#videos_to_keep[@]}"
    echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
}

# Version check (early exit, no banners)
if [[ "${1:-}" == "--version" ]] || [[ "${1:-}" == "-v" ]]; then
    echo "YutubuDownload v1.0.1 (2026-02-08) â€¢ Tanzania-Optimized"
    exit 0
fi

# Force download option
if [[ "${1:-}" == "--force-download" ]] || [[ "${1:-}" == "-f" ]]; then
    FORCE_DOWNLOAD="true"
    shift
else
    FORCE_DOWNLOAD="false"
fi

# === BADASS HACKER-STYLE GRADIENT BANNER ===
{
  echo -e "\033[38;5;51mâ––â––  â–—   â–Œ   â–„        â–œ      â–Œ"
  echo -e "\033[38;5;46mâ–Œâ–Œâ–Œâ–Œâ–œâ–˜â–Œâ–Œâ–›â–Œâ–Œâ–Œâ–Œâ–Œâ–›â–Œâ–Œâ–Œâ–Œâ–›â–Œâ– â–›â–Œâ–€â–Œâ–›â–Œ"
  echo -e "\033[38;5;39mâ– â–™â–Œâ–â––â–™â–Œâ–™â–Œâ–™â–Œâ–™â–˜â–™â–Œâ–šâ–šâ–˜â–Œâ–Œâ–â––â–™â–Œâ–ˆâ–Œâ–™â–Œ"
  echo -e "\033[0m"
} >/dev/tty 2>/dev/null || {
  echo "YutubuDownload"
}

# === CUSTOM SWAHILI-TECH HEADER (COLORED BLOCK ART) ===
{
    echo -e "${BRIGHT_CYAN}YutubeDownload, v1.0.1${RESET}"
} >/dev/tty 2>/dev/null || echo ""

# === SMART COOKIE REFRESH (ANIMATED) ===
echo -e "${SKY_BLUE}ğŸ”„ Preparing Chrome cookies (Tanzania-optimized)...${RESET}"
pkill -f "chrome" 2>/dev/null || true
pkill -f "chromium" 2>/dev/null || true
pkill -f "crashpad" 2>/dev/null || true

print_loading "â³ Unlocking cookies"

google-chrome-stable --no-startup-window 2>/dev/null &
CHROME_PID=$!
sleep 3
kill $CHROME_PID 2>/dev/null || true
wait $CHROME_PID 2>/dev/null || true
echo -e "${LIME}âœ… Cookies refreshed in 8 seconds${RESET}"
echo ""

# === ROBUST DBUS SESSION SETUP ===
if [ -z "${DBUS_SESSION_BUS_ADDRESS+x}" ]; then
    for source in "gnome-session" "systemd" "dbus-daemon"; do
        PID=$(pgrep -u "$USER" -f "$source" 2>/dev/null | head -n1 || true)
        if [ -n "$PID" ] && [ -f "/proc/$PID/environ" ]; then
            export $(tr '\0' '\n' < "/proc/$PID/environ" 2>/dev/null | grep -m1 "^DBUS_SESSION_BUS_ADDRESS=" || echo "DBUS_SESSION_BUS_ADDRESS=disabled")
            break
        fi
    done
    if [ -z "${DBUS_SESSION_BUS_ADDRESS+x}" ]; then
        export DBUS_SESSION_BUS_ADDRESS=disabled
    fi
fi

# Activate virtual environment
VENV_PATH="$HOME/youtubedownloading/yt-venv/bin/activate"
if [ -f "$VENV_PATH" ]; then
    source "$VENV_PATH" 2>/dev/null || true
    echo -e "${LIME}âœ… Activated virtual environment (yt-venv) for cookie decryption${RESET}"
else
    VENV_PATH="/root/youtubedownloading/yt-venv/bin/activate"
    if [ -f "$VENV_PATH" ]; then
        source "$VENV_PATH" 2>/dev/null || true
        echo -e "${LIME}âœ… Activated system virtual environment (yt-venv)${RESET}"
    else
        print_error "âš ï¸  Warning: yt-venv not found at ~/youtubedownloading/yt-venv"
        echo "   Cookie decryption may fail. Run installer:"
        echo -e "   ${CYAN}sudo bash -c '\$(curl -sL https://raw.githubusercontent.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal/main/install.sh)'${RESET}"
    fi
fi

echo ""

# Dependency checks
if ! command -v yt-dlp &> /dev/null; then
    print_error "âŒ ERROR: yt-dlp not found!"
    echo "   Install with installer:"
    echo -e "   ${CYAN}sudo bash -c '\$(curl -sL https://raw.githubusercontent.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal/main/install.sh)'${RESET}"
    exit 1
fi

if ! command -v ffmpeg &> /dev/null; then
    print_error "âš ï¸  WARNING: ffmpeg missing â†’ Videos will have NO AUDIO!"
    echo "   Install IMMEDIATELY:"
    echo -e "   ${CYAN}sudo apt install ffmpeg${RESET}"
    echo ""
fi

# Auto-detect JS runtime (Deno preferred)
JS_RUNTIME=""
if command -v deno &> /dev/null; then
    JS_RUNTIME="--js-runtimes deno"
    echo -e "${SKY_BLUE}âš¡ Using Deno for YouTube JS challenges (recommended)${RESET}"
elif command -v node &> /dev/null; then
    JS_RUNTIME="--js-runtimes node"
    echo -e "${SKY_BLUE}âš¡ Using Node.js for YouTube JS challenges${RESET}"
else
    print_error "âš ï¸  WARNING: No JS runtime found! YouTube may block high-quality downloads."
    echo "   Install Deno (recommended):"
    echo -e "   ${CYAN}curl -fsSL https://deno.land/install.sh | sh${RESET}"
fi
echo ""

# URL input - Enhanced visibility
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${BRIGHT_CYAN}ğŸ“¥ URL INPUT${RESET}"
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${CYAN}Enter YouTube URL (video or playlist):${RESET}"
echo -n -e "${BRIGHT_CYAN}> ${RESET}"
read -r URL || { echo ""; exit 1; }
URL=$(echo "$URL" | xargs)

if [[ -z "$URL" ]]; then
    print_error "âŒ No URL provided. Exiting."
    exit 1
fi
echo ""

# Download type selection
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${BRIGHT_CYAN}ğŸ“‹ DOWNLOAD TYPE${RESET}"
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${CYAN}What to download?${RESET}"
echo -e "  ${BRIGHT_BLUE}1${RESET} = Single video (ignores playlist params in URL)"
echo -e "  ${BRIGHT_BLUE}2${RESET} = Full playlist"
echo -n -e "${BRIGHT_CYAN}Enter choice (1/2) [default=1]: ${RESET}"
read -r TYPE_CHOICE || TYPE_CHOICE="1"
TYPE_CHOICE="${TYPE_CHOICE:-1}"
TYPE_CHOICE=$(echo "$TYPE_CHOICE" | xargs)

IS_PLAYLIST="false"
PLAYLIST_FLAG="--no-playlist"
OUTPUT_TEMPLATE="%(title)s.%(ext)s"

if [[ "$TYPE_CHOICE" == "2" ]]; then
    IS_PLAYLIST="true"
    PLAYLIST_FLAG="--yes-playlist"
    echo ""
    echo -e "${SKY_BLUE}â„¹ï¸  Playlist mode: Will download ALL videos in playlist${RESET}"
else
    echo ""
    echo -e "${SKY_BLUE}â„¹ï¸  Single video mode: Will download ONLY this video (ignores ?list= params)${RESET}"
fi
echo ""

# Format selection
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${BRIGHT_CYAN}ğŸµ FORMAT SELECTION${RESET}"
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${CYAN}Download as:${RESET}"
echo -e "  ${BRIGHT_BLUE}1${RESET} = Video (with audio)"
echo -e "  ${BRIGHT_BLUE}2${RESET} = MP3 (audio only)"
echo -n -e "${BRIGHT_CYAN}Enter choice (1/2) [default=1]: ${RESET}"
read -r FORMAT_CHOICE || FORMAT_CHOICE="1"
FORMAT_CHOICE="${FORMAT_CHOICE:-1}"
FORMAT_CHOICE=$(echo "$FORMAT_CHOICE" | xargs)

IS_MP3="false"
MP3_FLAGS=""
FORMAT="bestvideo+bestaudio/best"
AUDIO_QUAL="0"

if [[ "$FORMAT_CHOICE" == "2" ]]; then
    IS_MP3="true"
    MP3_FLAGS="-x --audio-format mp3"
   
    echo ""
    echo -e "${CYAN}MP3 quality options:${RESET}"
    echo -e "  ${BRIGHT_BLUE}1${RESET} = Best (VBR ~320kbps)"
    echo -e "  ${BRIGHT_BLUE}2${RESET} = High (192kbps)"
    echo -e "  ${BRIGHT_BLUE}3${RESET} = Medium (128kbps)"
    echo -n -e "${BRIGHT_CYAN}Enter choice (1-3) [default=1]: ${RESET}"
    read -r QUAL_CHOICE || QUAL_CHOICE="1"
    QUAL_CHOICE="${QUAL_CHOICE:-1}"
    QUAL_CHOICE=$(echo "$QUAL_CHOICE" | xargs)
   
    case "$QUAL_CHOICE" in
        2) AUDIO_QUAL="192K" ;;
        3) AUDIO_QUAL="128K" ;;
        *) AUDIO_QUAL="0" ;;
    esac
   
    MP3_FLAGS="$MP3_FLAGS --audio-quality $AUDIO_QUAL"
    FORMAT="bestaudio"
fi
echo ""

# === ENHANCED QUALITY SELECTION (ALL STANDARD RESOLUTIONS â‰¥360P) ===
if [[ "$IS_MP3" == "false" ]]; then
    echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${BRIGHT_CYAN}ğŸ¬ QUALITY SELECTION${RESET}"
    echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${SKY_BLUE}ğŸ” Fetching available qualities... (usually 2-5 seconds)${RESET}"
   
    ACTUAL_HEIGHTS=$(timeout 15 yt-dlp --cookies-from-browser chrome --no-playlist \
        --print "%(height)s" "$URL" 2>/dev/null | \
        grep -E '^[0-9]+$' | sort -nur | uniq | head -n 10 || echo "")
   
    STANDARD_HEIGHTS=(2160 1440 1080 720 480 360)
    DISPLAY_HEIGHTS=""
   
    if [[ -n "$ACTUAL_HEIGHTS" ]]; then
        for h in $ACTUAL_HEIGHTS; do
            if [[ " ${STANDARD_HEIGHTS[*]} " =~ " $h " ]]; then
                DISPLAY_HEIGHTS="$DISPLAY_HEIGHTS $h"
            fi
        done
       
        for std in "${STANDARD_HEIGHTS[@]}"; do
            if [[ ! " $DISPLAY_HEIGHTS " =~ " $std " ]]; then
                DISPLAY_HEIGHTS="$DISPLAY_HEIGHTS $std"
            fi
        done
    else
        DISPLAY_HEIGHTS="${STANDARD_HEIGHTS[*]}"
    fi
   
    DISPLAY_HEIGHTS=$(echo $DISPLAY_HEIGHTS | tr ' ' '\n' | sort -nur | uniq | tr '\n' ' ')
   
    echo -e "${LIME}âœ… Available standard qualities: $DISPLAY_HEIGHTS${RESET}"
    echo -n -e "${BRIGHT_CYAN}Enter max height (e.g. 720, 1080) [default=720]: ${RESET}"
    read -r MAX_HEIGHT || MAX_HEIGHT="720"
    MAX_HEIGHT="${MAX_HEIGHT:-720}"
    MAX_HEIGHT=$(echo "$MAX_HEIGHT" | xargs)
   
    if [[ ! " ${STANDARD_HEIGHTS[*]} " =~ " $MAX_HEIGHT " ]]; then
        print_error "âš ï¸  Invalid height. Using default 720p."
        MAX_HEIGHT=720
    fi
   
    FORMAT="bestvideo[height<=${MAX_HEIGHT}][ext=mp4]+bestaudio[ext=m4a]/best[height<=${MAX_HEIGHT}][ext=mp4]/bestvideo[height<=${MAX_HEIGHT}]+bestaudio/best[height<=${MAX_HEIGHT}]"
else
    MAX_HEIGHT="N/A"
fi
echo ""

# Folder organization
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${BRIGHT_CYAN}ğŸ“ FOLDER ORGANIZATION${RESET}"
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"

FOLDER_NAME=""
USE_FOLDER="false"

if [[ "$IS_PLAYLIST" == "true" ]]; then
    echo -e "${CYAN}Create dedicated folder for playlist? (HIGHLY RECOMMENDED)${RESET}"
    echo "   Prevents mixing files from playlists with identical names"
    echo -n -e "   ${BRIGHT_CYAN}y${RESET} = Yes (safe default) | ${BRIGHT_CYAN}n${RESET} = No [default=y]: "
    read -r FOLDER_CHOICE || FOLDER_CHOICE="y"
    FOLDER_CHOICE="${FOLDER_CHOICE:-y}"
    FOLDER_CHOICE=$(echo "$FOLDER_CHOICE" | xargs | tr '[:upper:]' '[:lower:]')
   
    if [[ "${FOLDER_CHOICE}" == "y" || "${FOLDER_CHOICE}" == "" ]]; then
        USE_FOLDER="true"
        echo -n -e "${BRIGHT_CYAN}Folder name? (leave blank for auto): ${RESET}"
        read -r FOLDER_NAME || FOLDER_NAME=""
        FOLDER_NAME=$(echo "$FOLDER_NAME" | xargs)
        FOLDER_NAME="${FOLDER_NAME:-%(playlist_title)s [%(playlist_id)s]}"
        OUTPUT_TEMPLATE="${FOLDER_NAME}/%(playlist_index)02d - %(title)s.%(ext)s"
    else
        OUTPUT_TEMPLATE="%(playlist_index)02d - %(title)s.%(ext)s"
    fi
else
    echo -n -e "${CYAN}Save in custom folder? (${BRIGHT_CYAN}y${RESET}/${BRIGHT_CYAN}n${RESET}) [default=n]: ${RESET}"
    read -r FOLDER_CHOICE || FOLDER_CHOICE="n"
    FOLDER_CHOICE="${FOLDER_CHOICE:-n}"
    FOLDER_CHOICE=$(echo "$FOLDER_CHOICE" | xargs | tr '[:upper:]' '[:lower:]')
   
    if [[ "${FOLDER_CHOICE}" == "y" ]]; then
        USE_FOLDER="true"
        echo -n -e "${BRIGHT_CYAN}Folder name (e.g. 'BongoFlava'): ${RESET}"
        read -r FOLDER_NAME || FOLDER_NAME="Downloads"
        FOLDER_NAME=$(echo "$FOLDER_NAME" | xargs)
        FOLDER_NAME="${FOLDER_NAME:-Downloads}"
        OUTPUT_TEMPLATE="${FOLDER_NAME}/%(title)s.%(ext)s"
    fi
fi
echo ""

# === ARCHIVE HANDLING ===
ARCHIVE_FILE="$HOME/yt-downloads-archive.txt"
touch "$ARCHIVE_FILE" 2>/dev/null || true

# For single videos: check and ask
if [[ "$IS_PLAYLIST" == "false" ]]; then
    VIDEO_ID=$(extract_video_id "$URL")
    
    if [[ -n "$VIDEO_ID" ]] && grep -qxF "$VIDEO_ID" "$ARCHIVE_FILE" 2>/dev/null; then
        echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo -e "${ORANGE}âš ï¸  âš ï¸  âš ï¸  VIDEO ALREADY IN ARCHIVE  âš ï¸  âš ï¸  âš ï¸${RESET}"
        echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
        echo -e "   ${CYAN}Video ID:${RESET} $VIDEO_ID"
        echo -e "   ${ORANGE}âš ï¸  This video was previously downloaded${RESET}"
        echo ""
        
        if [[ "$FORCE_DOWNLOAD" == "true" ]]; then
            echo -e "${LIME}âš ï¸  Force download mode enabled - proceeding anyway${RESET}"
            echo ""
        else
            echo -e "   ${CYAN}Options:${RESET}"
            echo -e "     ${BRIGHT_GREEN}y${RESET} = YES â†’ Delete from archive + re-download"
            echo -e "     ${BRIGHT_RED}n${RESET} = NO  â†’ Skip download (safe default)"
            echo -n -e "   ${BRIGHT_CYAN}Delete from archive and re-download? (y/N): ${RESET}"
            read -r CHOICE
            CHOICE=$(echo "${CHOICE:-n}" | tr '[:upper:]' '[:lower:]')
            echo ""
           
            if [[ "$CHOICE" == "y" ]]; then
                grep -vxF "$VIDEO_ID" "$ARCHIVE_FILE" > "${ARCHIVE_FILE}.tmp" 2>/dev/null || true
                mv "${ARCHIVE_FILE}.tmp" "$ARCHIVE_FILE" 2>/dev/null || true
                echo -e "${LIME}âœ… DELETED video $VIDEO_ID from archive. Proceeding with fresh download...${RESET}"
                echo ""
            else
                echo -e "${LIME}âœ… SKIPPED video $VIDEO_ID per your choice.${RESET}"
                exit 0
            fi
        fi
    fi
fi

# For playlists: Two-pass approach
if [[ "$IS_PLAYLIST" == "true" ]]; then
    echo -e "${SKY_BLUE}ğŸ”„ Checking playlist archive...${RESET}"
    process_playlist_archive "$URL" "$ARCHIVE_FILE"
    echo -e "${SKY_BLUE}ğŸ”„ Starting actual download now...${RESET}"
    echo ""
fi

# Execution summary
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${BRIGHT_CYAN}ğŸš€ DOWNLOAD SUMMARY${RESET}"
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${CYAN}URL:${RESET}          $URL"
echo -e "${CYAN}Type:${RESET}         $( [[ "$IS_PLAYLIST" == "true" ]] && echo "${BRIGHT_GREEN}Playlist (ALL videos)${RESET}" || echo "${BRIGHT_BLUE}Single Video ONLY${RESET}" )"
echo -e "${CYAN}Format:${RESET}       $( [[ "$IS_MP3" == "true" ]] && echo "${BRIGHT_MAGENTA}MP3 ($AUDIO_QUAL)${RESET}" || echo "${BRIGHT_BLUE}Video (max ${MAX_HEIGHT}p) WITH AUDIO${RESET}" )"
echo -e "${CYAN}Destination:${RESET}  $( [[ "$USE_FOLDER" == "true" ]] && echo "${BRIGHT_YELLOW}$FOLDER_NAME${RESET}" || echo "${BRIGHT_YELLOW}Current directory${RESET}" )"
echo -e "${CYAN}JS Runtime:${RESET}   $( [[ -n "$JS_RUNTIME" ]] && echo "${BRIGHT_GREEN}${JS_RUNTIME##*=}${RESET}" || echo "${ORANGE}None${RESET}" )"
echo -e "${CYAN}Archive:${RESET}      $( [[ "$IS_PLAYLIST" == "true" ]] && echo "${BRIGHT_GREEN}Enabled${RESET}" || echo "${ORANGE}N/A${RESET}" )"
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

# === ENHANCED PROGRESS BAR CONFIGURATION ===
BAR_WIDTH=20

# Cursor movement
CSI="\033["
HIDE_CURSOR="${CSI}?25l"
SHOW_CURSOR="${CSI}?25h"
CLEAR_LINE="${CSI}2K"
GOTO_COL1="${CSI}0G"
UP_1="${CSI}1A"
DOWN_1="${CSI}1B"

# Hide cursor and set up cleanup trap
echo -e "$HIDE_CURSOR"
trap 'echo -e "${SHOW_CURSOR}"; echo -e "\r${CLEAR_LINE}${GOTO_COL1}"; echo -e "${UP_1}${CLEAR_LINE}${GOTO_COL1}"; exit' INT TERM EXIT

# Display location based on user choice
DISPLAY_LOCATION="${FOLDER_NAME:-Current directory}"

echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${BRIGHT_CYAN}ğŸ“¥ DOWNLOAD IN PROGRESS${RESET}"
echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${SKY_BLUE}Starting download... (progress will update in 2 fixed lines)${RESET}"

# === MODIFIED yt-dlp COMMAND WITH RESTART LOGIC ===
DOWNLOAD_SUCCESS=false
ARCHIVE_CHANGED=false  # Track if archive was modified
VIDEOS_TO_REMOVE=()   # Store videos to remove
RESTART_COUNT=0

for ATTEMPT in 1 2 3; do
    # Reset restart count for each new attempt
    RESTART_COUNT=0
    
    if yt-dlp \
        $PLAYLIST_FLAG \
        $MP3_FLAGS \
        -f "$FORMAT" \
        -o "$OUTPUT_TEMPLATE" \
        $JS_RUNTIME \
        --cookies-from-browser chrome \
        --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
        --ignore-errors \
        --continue \
        --no-overwrites \
        --merge-output-format mp4 \
        --download-archive "$ARCHIVE_FILE" \
        --newline \
        --no-warnings \
        --progress-template "download:%(progress.downloaded_bytes)s %(progress.total_bytes)s %(progress._percent_str)s %(progress._eta_str)s %(progress._speed_str)s" \
        --output-na-placeholder "-" \
        "$URL" 2>&1 | while IFS= read -r line; do
        
        # INTERCEPT ARCHIVE MESSAGES AND ASK USER
        if [[ "$line" =~ "has already been recorded in the archive" ]]; then
            if [[ "$line" =~ \[download\]\ ([^:]+): ]]; then
                VIDEO_ID="${BASH_REMATCH[1]}"
                
                # Show the user the archived video
                echo ""
                echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo -e "${ORANGE}âš ï¸  VIDEO ALREADY IN ARCHIVE DETECTED  âš ï¸${RESET}"
                echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                echo -e "   ${CYAN}Video ID:${RESET} $VIDEO_ID"
                echo -e "   ${CYAN}URL:${RESET} https://youtu.be/$VIDEO_ID"
                echo -e "   ${ORANGE}âš ï¸  This video was previously downloaded${RESET}"
                echo ""
                
                echo -e "   ${CYAN}Options:${RESET}"
                echo -e "     ${BRIGHT_GREEN}r${RESET} = RE-DOWNLOAD (remove from archive)"
                echo -e "     ${BRIGHT_BLUE}s${RESET} = SKIP (keep in archive)"
                echo -e "     ${BRIGHT_YELLOW}a${RESET} = Apply to ALL remaining archived videos"
                echo -n -e "   ${BRIGHT_CYAN}Your choice (r/s/a) [default=s]: ${RESET}"
                
                # Read from terminal, not from pipe
                read -r choice </dev/tty
                choice=$(echo "${choice:-s}" | tr '[:upper:]' '[:lower:]')
                
                case "$choice" in
                    r)
                        # Add to removal list
                        VIDEOS_TO_REMOVE+=("$VIDEO_ID")
                        ARCHIVE_CHANGED=true
                        echo -e "   ${LIME}âœ… Marked $VIDEO_ID for removal from archive${RESET}"
                        echo -e "   ${SKY_BLUE}âš ï¸  Restarting download to include this video...${RESET}"
                        echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                        echo ""
                        
                        # Update archive immediately
                        grep -vxF "$VIDEO_ID" "$ARCHIVE_FILE" > "${ARCHIVE_FILE}.tmp" 2>/dev/null || true
                        mv "${ARCHIVE_FILE}.tmp" "$ARCHIVE_FILE" 2>/dev/null || true
                        
                        # Kill yt-dlp to force restart
                        pkill -f "yt-dlp.*$URL" 2>/dev/null || true
                        exit 130  # Exit with SIGINT code to trigger restart
                        ;;
                    a)
                        # Remove ALL archived videos from archive
                        echo -n -e "   ${BRIGHT_CYAN}Remove ALL archived videos from archive? (y/N): ${RESET}"
                        read -r confirm </dev/tty
                        confirm=$(echo "${confirm:-n}" | tr '[:upper:]' '[:lower:]')
                        if [[ "$confirm" == "y" ]]; then
                            # Clear the archive file
                            > "$ARCHIVE_FILE"
                            ARCHIVE_CHANGED=true
                            echo -e "   ${LIME}âœ… Cleared entire archive. All videos will be downloaded.${RESET}"
                            echo -e "   ${SKY_BLUE}âš ï¸  Restarting download...${RESET}"
                            echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                            echo ""
                            # Kill yt-dlp to force restart
                            pkill -f "yt-dlp.*$URL" 2>/dev/null || true
                            exit 130  # Exit with SIGINT code to trigger restart
                        else
                            echo -e "   ${LIME}âœ… Keeping archive as is. Skipping this video.${RESET}"
                            echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                            echo ""
                        fi
                        ;;
                    *)
                        # Skip this video (default)
                        echo -e "   ${LIME}âœ… Skipping $VIDEO_ID per your choice.${RESET}"
                        echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                        echo ""
                        ;;
                esac
            fi
            continue
        fi
       
        # Color metadata lines
        if [[ "$line" =~ ^\[ ]]; then
            # Color different types of metadata lines
            if [[ "$line" =~ ^\[download\].*Downloading.*playlist ]]; then
                echo -e "${BRIGHT_MAGENTA}$line${RESET}"
            elif [[ "$line" =~ ^\[download\].*Downloading.*item.*of ]]; then
                echo -e "${BRIGHT_CYAN}$line${RESET}"
            elif [[ "$line" =~ ^\[youtube\].*Extracting.*URL ]]; then
                echo -e "${SKY_BLUE}$line${RESET}"
            elif [[ "$line" =~ ^\[download\] ]]; then
                echo -e "${BRIGHT_BLUE}$line${RESET}"
            elif [[ "$line" =~ ^\[youtube\] ]]; then
                echo -e "${BLUE}$line${RESET}"
            elif [[ "$line" =~ ^\[ExtractAudio\] ]]; then
                echo -e "${BRIGHT_GREEN}$line${RESET}"
            elif [[ "$line" =~ ^\[Merger\] ]]; then
                echo -e "${BRIGHT_GREEN}$line${RESET}"
            else
                echo -e "${CYAN}$line${RESET}"
            fi
            continue
        fi
       
        # Parse progress line
        read -r downloaded total percent eta speed <<< "$line"
       
        if [[ "$percent" =~ ^([0-9]+)(\.[0-9]+)?%$ ]]; then
            percent_int="${BASH_REMATCH[1]}"
           
            # Calculate downloaded MiB correctly
            if [[ "$downloaded" =~ ^[0-9]+$ ]] && [ "$downloaded" -gt 0 ]; then
                dl_mib=$(( downloaded / 1048576 ))
            else
                dl_mib=0
            fi
           
            # Calculate total MiB correctly  
            if [[ "$total" =~ ^[0-9]+$ ]] && [ "$total" -gt 0 ]; then
                tot_mib=$(( total / 1048576 ))
            else
                tot_mib=0
            fi
           
            # Create progress bar
            filled=$(( (percent_int * BAR_WIDTH) / 100 ))
            bar=$(printf 'â–ˆ%.0s' $(seq 1 "$filled"))
            empty=$(printf 'â–‘%.0s' $(seq 1 $((BAR_WIDTH - filled))))
            full_bar="$bar$empty"
           
            if [ "$percent_int" -ge 99 ]; then
                percent_display="100.0%"
                printf "${UP_1}${CLEAR_LINE}${GOTO_COL1}"
                printf "Downloading: ${GREEN}%s${RESET} %s ${BRIGHT_BLUE}[%dMiB/%dMiB]${RESET}${BRIGHT_GREEN} Done!${RESET}" \
                    "$full_bar" "$percent_display" "$dl_mib" "$tot_mib"
            else
                printf "${UP_1}${CLEAR_LINE}${GOTO_COL1}"
                printf "Downloading: ${GREEN}%s${RESET} %s ${BRIGHT_BLUE}[%dMiB/%dMiB]${RESET}" \
                    "$full_bar" "$percent" "$dl_mib" "$tot_mib"
            fi
           
            # Second line with ETA, Speed, and Location
            printf "${DOWN_1}${CLEAR_LINE}${GOTO_COL1}"
            printf "ETA: ${YELLOW}%s${RESET} | Speed: ${CYAN}%s${RESET} | Location: ${MAGENTA}%s${RESET}" \
                "$eta" "$speed" "$DISPLAY_LOCATION"
           
            sleep 0.3
        fi
       
        # Post-processing detection
        if [[ "$line" =~ \[ExtractAudio\] || "$line" =~ Destination:.*\.mp3 ]] || [[ "$line" =~ \[Merger\] ]]; then
            printf "${UP_1}${CLEAR_LINE}${GOTO_COL1}"
            if [[ "$IS_MP3" == "true" ]]; then
                printf "Downloading: ${GREEN}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ${RESET} 100.0%% ${BRIGHT_BLUE}[${BRIGHT_GREEN}Done${RESET}${BRIGHT_BLUE}]${RESET} - converting to MP3..."
            else
                printf "Downloading: ${GREEN}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ${RESET} 100.0%% ${BRIGHT_BLUE}[${BRIGHT_GREEN}Done${RESET}${BRIGHT_BLUE}]${RESET} - merging audio/video..."
            fi
            printf "${DOWN_1}${CLEAR_LINE}${GOTO_COL1}"
            printf "Post-processing in progress... please wait"
        fi
       
    done; then
        # If we get here, download completed normally
        DOWNLOAD_SUCCESS=true
        break
    else
        EXIT_CODE=$?
        
        # Check if it was a restart request (exit code 130 = SIGINT)
        if [[ $EXIT_CODE -eq 130 ]]; then
            ((RESTART_COUNT++))
            echo -e "\n${SKY_BLUE}ğŸ”„ Archive updated. Restarting download (restart #$RESTART_COUNT)...${RESET}"
            echo ""
            
            # Reset flags for next iteration
            ARCHIVE_CHANGED=false
            VIDEOS_TO_REMOVE=()
            
            # Continue with next loop iteration (which will restart yt-dlp)
            if [[ $RESTART_COUNT -lt 5 ]]; then  # Limit restarts to 5 times
                continue
            else
                echo -e "${ORANGE}âš ï¸  Too many restarts. Continuing with current archive state.${RESET}"
                DOWNLOAD_SUCCESS=true
                break
            fi
        else
            echo ""
            if [[ $ATTEMPT -lt 3 ]]; then
                print_error "âš ï¸  Attempt $ATTEMPT failed. Refreshing cookies..."
                pkill -f "chrome" 2>/dev/null || true
                sleep 3
                google-chrome-stable --no-startup-window 2>/dev/null &
                CHROME_PID=$!
                sleep 3
                kill $CHROME_PID 2>/dev/null || true
                wait $CHROME_PID 2>/dev/null || true
                echo -e "${SKY_BLUE}ğŸ”„ Retrying (attempt $((ATTEMPT + 1))...${RESET}"
                sleep 2
            fi
        fi
    fi
done

# Show cursor again
echo -e "${SHOW_CURSOR}"

if [[ "$DOWNLOAD_SUCCESS" == false ]]; then
    echo ""
    echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    print_error "âŒ DOWNLOAD FAILED AFTER 3 ATTEMPTS"
    echo -e "${BRIGHT_MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${CYAN}   ğŸ’¡ TANZANIA FIX:${RESET}"
    echo -e "     1. Disconnect WiFi/Ethernet"
    echo -e "     2. Wait 10 seconds"
    echo -e "     3. Reconnect and retry"
    exit 1
fi

# === PERFECTLY ALIGNED COMPLETION BOX ===
echo ""
echo -e "${BRIGHT_GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${BRIGHT_GREEN}â•‘${RESET}                                                                              ${BRIGHT_GREEN}â•‘${RESET}"
printf "${BRIGHT_GREEN}â•‘${RESET} ${BRIGHT_GREEN}âœ… DOWNLOAD COMPLETE${RESET} at %-52s ${BRIGHT_GREEN}â•‘${RESET}\n" "$(date '+%I:%M:%S %p')"
echo -e "${BRIGHT_GREEN}â•‘${RESET}                                                                              ${BRIGHT_GREEN}â•‘${RESET}"

# Fixed line: Separate the color codes from the variable substitution
FOLDER_DISPLAY="$( [[ "$USE_FOLDER" == "true" ]] && echo "${FOLDER_NAME//\\033\[[0-9;]*m/}" || echo "Current directory" )"
printf "${BRIGHT_GREEN}â•‘${RESET} ${CYAN}Files saved:${RESET} %-63s ${BRIGHT_GREEN}â•‘${RESET}\n" "$FOLDER_DISPLAY"

# Fixed lines: Separate color codes from conditional logic
MODE_DISPLAY="$( [[ "$IS_PLAYLIST" == "true" ]] && echo "${BRIGHT_GREEN}FULL PLAYLIST${RESET}" || echo "SINGLE VIDEO ONLY" )"
printf "${BRIGHT_GREEN}â•‘${RESET} ${CYAN}â€¢ Mode:${RESET} %-68s ${BRIGHT_GREEN}â•‘${RESET}\n" "$MODE_DISPLAY"

printf "${BRIGHT_GREEN}â•‘${RESET} ${CYAN}â€¢ Audio:${RESET} ${BRIGHT_GREEN}GUARANTEED${RESET} (MP4 merge format)                                       ${BRIGHT_GREEN}â•‘${RESET}"
printf "\n${BRIGHT_GREEN}â•‘${RESET} ${CYAN}â€¢ Quality:${RESET} ${BRIGHT_GREEN}Standard resolutions (360p-4K) always available${RESET}                   ${BRIGHT_GREEN}â•‘${RESET}"
printf "\n${BRIGHT_GREEN}â•‘${RESET} ${CYAN}â€¢ Archive:${RESET} ${BRIGHT_GREEN}Updated automatically${RESET}                                          ${BRIGHT_GREEN}â•‘${RESET}"
echo -e "\n${BRIGHT_GREEN}â•‘${RESET}                                                                              ${BRIGHT_GREEN}â•‘${RESET}"
echo -e "${BRIGHT_GREEN}â•‘${RESET}    ${BRIGHT_CYAN}ğŸ’¡ TANZANIA TIPS:${RESET}                                                         ${BRIGHT_GREEN}â•‘${RESET}"
printf "${BRIGHT_GREEN}â•‘${RESET} ${CYAN}â€¢${RESET} Single video? Script ${BRIGHT_GREEN}IGNORES ?list= params${RESET}                                 ${BRIGHT_GREEN}â•‘${RESET}"
printf "\n${BRIGHT_GREEN}â•‘${RESET} ${CYAN}â€¢${RESET} Audio missing? ${BRIGHT_YELLOW}Re-download at 720p${RESET} (most reliable streams)                 ${BRIGHT_GREEN}â•‘${RESET}"
printf "\n${BRIGHT_GREEN}â•‘${RESET} ${CYAN}â€¢${RESET} Bot errors? Script ${BRIGHT_GREEN}auto-refreshes cookies${RESET}                                  ${BRIGHT_GREEN}â•‘${RESET}"
printf "\n${BRIGHT_GREEN}â•‘${RESET} ${CYAN}â€¢${RESET} Slow network? ${BRIGHT_YELLOW}720p works 95% of time on Vodacom/Airtel${RESET}                       ${BRIGHT_GREEN}â•‘${RESET}"
echo -e "\n${BRIGHT_GREEN}â•‘${RESET}                                                                              ${BRIGHT_GREEN}â•‘${RESET}"
printf "${BRIGHT_GREEN}â•‘${RESET} ${BRIGHT_MAGENTA}Enjoy your downloads! ğŸŒâœ¨${RESET}                                                   ${BRIGHT_GREEN}â•‘${RESET}"
printf "\n${BRIGHT_GREEN}â•‘${RESET} ${CYAN}Made with â¤ï¸  for Tanzania by Johnbosco (Dar es Salaam)${RESET}                       ${BRIGHT_GREEN}â•‘${RESET}"
echo -e "\n${BRIGHT_GREEN}â•‘${RESET}                                                                              ${BRIGHT_GREEN}â•‘${RESET}"
echo -e "${BRIGHT_GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

# === SIGNATURE: QUOTE FROM JOHN BOSCO + ALIEN ART (GREEN) ===
echo -e "\033[38;5;194m\"Out here doing some Alien things, Jesus is King...\" ~johnboscocjt (Isaiah 28:21)\033[0m"
echo -e "\033[38;5;82m"
cat << 'EOF'
                                    Â¸Â¸,..--------------------.....,Â¸
                      Â¸,..--Â·Â·ËœËœÂ¨Â¨                                     Â¨Â¨ËœÂ·.Â¸
                 Â¸.Â·Ëœ                                                          ËœÂ·Â¸
             Â¸.Â·Ëœ                                                          Â¸Ëœ    ËœÂ¸
         Â¸Â¸Â·''                                                           Â¸ Â·  ËœÂ¸  Ëœ
        Â¸ËœÂ¨  Â¸Â¸Ëœ                                                    Â¸.Â·ËœÂ¸ Â·Ëœ
       Â¸'     ËœÂ·Â¸                                         Â¸,..--Â·.Â¸

      Â¸'Â¸Â¸Â¸      Ëœ-.Â¸                                 Â¸,..---Â·Â·Â·-Â¸ËœÂ¨Â¸
    Â·ËœÂ¸Â¸Â¸Â¸Â¸Â¸Â¯Â¯ËœÂ·.Â¸      .Â¸Â·Ëœ                 Â¸,-Â·Ëœ;;;;;;;;;;;;Â¸'Ëœ
       Â¸Â·Ëœ ;;;;;;,ËœÂ·Â¸   ËœÂ¸      Ëœ.Â¸          Â¸.Ëœ;;;;;;;;;;;;;;;;Â¸'
      ';;;;;;;;;;;;;;;;Â¸Â¸ 'Â¸       Â´      Â¸Â·';;;;;;;;;;;;;;;;; Â¸Â´
      ';;;;;;;;;;;;;;;;;;'Â¸ ËœÂ¸         /Â¸/;;;;;;;;;;;;;;;; Â¸.Â·Ëœ Â¸Ëœ       Â¸Ëœ
       ËœÂ·.,Â¸Â¸Â¸.....----Â·Â¸/        Ëœ-Â¨ËœËœËœËœËœËœËœËœÂ¨Â¨Â¸Â¸,.Â·-'Ëœ               ËœÂ·Â¸Â·Ëœ
           ËœÂ¯Â¸Â¸Â¸Â¸Â¸   Â¸Â·Ëœ   Â¸Â·    Â´  Â¯Â¯Â¯Â¯Â¯                        Â¸Â·'Ëœ
              ËœÂ·Â¸   Â·Â¨Â¸Â¸,,,.Ëœ .,Â¸                               Â¸,.Â·ËœÂ¨
                  ËœÂ¨Â¸           Â¯ËœÂ·Â¸              Â¸.Â·Â·Â·ËœËœÂ·Â¸.Â·ËœÂ¨Â¸/
                     ËœÂ·Â¸Â¸Â¸,,,,Â¸Â¸Â¸Â¸   ËœÂ¸         Â¸Â·Ëœ   Â¸.Â·Ëœ,Ëœ Â¸Â·ËœÂ¨
                        Â¨Â¸Â¨ËœËœËœ'ËœÂ¨Â¨Â¯'   ËœÂ¸       ËœÂ¸,.Â·ËœÂ¸;     \Â¸
                          ËœÂ¸            ËœÂ¸.   Â¸Â·Ëœ;;;Ëœ         'Â¸
                           ËœÂ¸Â¸          Â¸,.-Â·Â¨Â¸;;;              'Â¸
                          Â¸,Â·Â´Â¯Â¨ËœËœËœÂ¨Â¯Â¯;;;;;;;Ëœ                 Ëœ.,Â¸Â¸Â¸
  ;;;;;;;;;;;;;;;;;  Â¸,.Â·Ëœ;;;;;;;;;;;;;;;;;;;Ëœ                          ËœÂ·Â¸ ';;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  ;;
    Â¨Â¨Â¨Â¨Â¨Â¨Â¨Â¨ËœËœËœËœËœËœËœËœ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''ËœËœËœËœËœËœËœËœËœËœËœÂ¨
EOF
echo -e "\033[0m"
echo ""
