#!/usr/bin/env bash
# YutubuDownload - Tanzania-Optimized YouTube Downloader for Ubuntu Terminal
# Author: Johnbosco | Updated: February 08, 2026
# GitHub: https://github.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal 

set -euo pipefail

# === TERMINAL DIMENSION DETECTION ===
get_terminal_width() {
    if command -v tput &> /dev/null; then
        tput cols 2>/dev/null || echo 80
    else
        echo 80
    fi
}

TERMINAL_WIDTH=$(get_terminal_width)

# Responsive width categories
if [ "$TERMINAL_WIDTH" -ge 120 ]; then
    WIDTH_CATEGORY="large"
elif [ "$TERMINAL_WIDTH" -ge 80 ]; then
    WIDTH_CATEGORY="medium"
elif [ "$TERMINAL_WIDTH" -ge 60 ]; then
    WIDTH_CATEGORY="small"
else
    WIDTH_CATEGORY="tiny"
fi

# === RESPONSIVE ASCII ART ===
print_responsive_banner() {
    case "$WIDTH_CATEGORY" in
        "large")
            {
                echo -e "\033[38;5;51m‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà             ‚ñà‚ñà‚ñà‚ñà‚ñà               ‚ñà‚ñà‚ñà‚ñà‚ñà                ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà                                       ‚ñà‚ñà‚ñà‚ñà                         ‚ñà‚ñà‚ñà‚ñà‚ñà"
                echo -e "\033[38;5;46m‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà             ‚ñë‚ñë‚ñà‚ñà‚ñà               ‚ñë‚ñë‚ñà‚ñà‚ñà                ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà                                     ‚ñë‚ñë‚ñà‚ñà‚ñà                        ‚ñë‚ñë‚ñà‚ñà‚ñà"
                echo -e "\033[38;5;46m ‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà   ‚ñë‚ñë‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñë‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
                echo -e "\033[38;5;39m  ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë   ‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà    ‚ñë‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà"
                echo -e "\033[38;5;39m   ‚ñë‚ñë‚ñà‚ñà‚ñà     ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà   ‚ñë‚ñà‚ñà‚ñà     ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà    ‚ñë‚ñà‚ñà‚ñà‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà"
                echo -e "\033[38;5;15m    ‚ñë‚ñà‚ñà‚ñà     ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà   ‚ñë‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà  ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà ‚ñë‚ñà‚ñà‚ñà"
                echo -e "\033[38;5;15m    ‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñë‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
                echo -e "\033[38;5;240m   ‚ñë‚ñë‚ñë‚ñë‚ñë      ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë    ‚ñë‚ñë‚ñë‚ñë‚ñë    ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë    ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë    ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë     ‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë    ‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë  ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë"
                echo -e "\033[0m"
            } >/dev/tty 2>/dev/null || true
            ;;
        "medium")
            {
                echo -e "\033[38;5;51m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo -e "\033[38;5;46m‚ïë   Y U T U B U   D O W N L O A D   (v1.0)            ‚ïë"
                echo -e "\033[38;5;39m‚ïë   Tanzania-Optimized YouTube Downloader            ‚ïë"
                echo -e "\033[38;5;15m‚ïë   Author: Johnbosco | Dar es Salaam                ‚ïë"
                echo -e "\033[38;5;240m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo -e "\033[0m"
            } >/dev/tty 2>/dev/null || true
            ;;
        "small")
            {
                echo -e "\033[38;5;51m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo -e "\033[38;5;46m‚ïë    YUTUBU DOWNLOAD v1.0        ‚ïë"
                echo -e "\033[38;5;39m‚ïë    Tanzania-Optimized          ‚ïë"
                echo -e "\033[38;5;240m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo -e "\033[0m"
            } >/dev/tty 2>/dev/null || true
            ;;
        "tiny")
            echo -e "\033[38;5;46mYTDL v1.0 (TZ)\033[0m"
            ;;
    esac
}

print_responsive_separator() {
    local width=$1
    local char="${2:-‚ïê}"
    local padding=$(( (width - 4) > 0 ? width - 4 : 60 ))
    echo "‚ïî$(printf "%${padding}s" | tr ' ' "$char")‚ïó"
}

print_responsive_box_line() {
    local width=$1
    local text="$2"
    local align="${3:-left}"
    local padding=$(( (width - 4) > 0 ? width - 4 : 60 ))
    
    case "$align" in
        "left")
            printf "‚ïë %-${padding}s ‚ïë\n" "$text"
            ;;
        "center")
            local text_len=${#text}
            local left_pad=$(( (padding - text_len) / 2 ))
            local right_pad=$(( padding - text_len - left_pad ))
            printf "‚ïë%${left_pad}s%s%${right_pad}s‚ïë\n" " " "$text" " "
            ;;
        "right")
            printf "‚ïë %${padding}s ‚ïë\n" "$text"
            ;;
    esac
}

print_responsive_box_bottom() {
    local width=$1
    local char="${2:-‚ïê}"
    local padding=$(( (width - 4) > 0 ? width - 4 : 60 ))
    echo "‚ïö$(printf "%${padding}s" | tr ' ' "$char")‚ïù"
}

# === ANIMATED FEEDBACK FUNCTIONS ===
print_loading() {
    local msg="$1"
    echo -ne "\033[38;5;46m$msg\033[0m"
    for _ in {1..3}; do
        echo -ne "."
        sleep 0.3
    done
    echo -e " ‚úÖ\033[0m"
}

print_error() {
    local msg="$1"
    local width=$TERMINAL_WIDTH
    if [ ${#msg} -gt $((width - 10)) ]; then
        msg="${msg:0:$((width - 13))}..."
    fi
    echo -ne "\033[38;5;196m$msg\033[0m"
    for _ in {1..2}; do
        echo -ne " ‚ùó"
        sleep 0.2
    done
    echo -e " ‚ùå\033[0m"
}

# Version check (early exit, no banners)
if [[ "${1:-}" == "--version" ]] || [[ "${1:-}" == "-v" ]]; then
    echo "YutubuDownload v1.0 (2026-02-08) ‚Ä¢ Tanzania-Optimized"
    exit 0
fi

# Clear screen and show banner
clear
print_responsive_banner

# === SMART COOKIE REFRESH (ANIMATED) ===
print_loading "üîÑ Preparing Chrome cookies (Tanzania-optimized)"

pkill -f "chrome" 2>/dev/null || true
pkill -f "chromium" 2>/dev/null || true
pkill -f "crashpad" 2>/dev/null || true

google-chrome-stable --no-startup-window 2>/dev/null &
CHROME_PID=$!
sleep 3
kill $CHROME_PID 2>/dev/null || true
wait $CHROME_PID 2>/dev/null || true
echo -e "\033[38;5;46m‚úÖ Cookies refreshed\033[0m"
echo ""

# === ROBUST DBUS SESSION SETUP ===
if [ -z "${DBUS_SESSION_BUS_ADDRESS+x}" ]; then
    for source in "gnome-session" "systemd" "dbus-daemon"; do
        PID=$(pgrep -u "$USER" -f "$source" 2>/dev/null | head -n1 || true)
        if [ -n "$PID" ] && [ -f "/proc/$PID/environ" ]; then
            export $(tr '\0' '\n' < "/proc/$PID/environ" 2>/dev/null | grep -m1 "^DBUS_SESSION_BUS_ADDRESS=" || echo "DBUS_SESSION_BUS_ADDRESS=disabled")
            break
        fi
    done
    if [ -z "${DBUS_SESSION_BUS_ADDRESS+x}" ]; then
        export DBUS_SESSION_BUS_ADDRESS=disabled
    fi
fi

# Activate virtual environment
VENV_PATH="$HOME/youtubedownloading/yt-venv/bin/activate"
if [ -f "$VENV_PATH" ]; then
    source "$VENV_PATH" 2>/dev/null || true
    echo -e "\033[38;5;46m‚úÖ Activated virtual environment (yt-venv) for cookie decryption\033[0m"
else
    VENV_PATH="/root/youtubedownloading/yt-venv/bin/activate"
    if [ -f "$VENV_PATH" ]; then
        source "$VENV_PATH" 2>/dev/null || true
        echo -e "\033[38;5;46m‚úÖ Activated system virtual environment (yt-venv)\033[0m"
    else
        print_error "‚ö†Ô∏è  Warning: yt-venv not found at ~/youtubedownloading/yt-venv"
        echo "   Cookie decryption may fail. Run installer:"
        echo "   sudo bash -c '\$(curl -sL https://raw.githubusercontent.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal/main/install.sh )'"
    fi
fi

echo ""

# Dependency checks
if ! command -v yt-dlp &> /dev/null; then
    print_error "‚ùå ERROR: yt-dlp not found!"
    echo "   Install with installer:"
    echo "   sudo bash -c '\$(curl -sL https://raw.githubusercontent.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal/main/install.sh )'"
    exit 1
fi

if ! command -v ffmpeg &> /dev/null; then
    print_error "‚ö†Ô∏è  WARNING: ffmpeg missing ‚Üí Videos will have NO AUDIO!"
    echo "   Install IMMEDIATELY: sudo apt install ffmpeg"
    echo ""
fi

# Auto-detect JS runtime (Deno preferred)
JS_RUNTIME=""
if command -v deno &> /dev/null; then
    JS_RUNTIME="--js-runtimes deno"
    echo -e "\033[38;5;39m‚ö° Using Deno for YouTube JS challenges (recommended)\033[0m"
elif command -v node &> /dev/null; then
    JS_RUNTIME="--js-runtimes node"
    echo -e "\033[38;5;39m‚ö° Using Node.js for YouTube JS challenges\033[0m"
else
    print_error "‚ö†Ô∏è  WARNING: No JS runtime found! YouTube may block high-quality downloads."
    echo "   Install Deno (recommended): curl -fsSL https://deno.land/install.sh  | sh"
fi
echo ""

# URL input
print_responsive_box_line $TERMINAL_WIDTH "paste YouTube link (video or playlist):"
print_responsive_box_line $TERMINAL_WIDTH "> " "left"
read -r URL || { echo ""; exit 1; }
URL=$(echo "$URL" | xargs)

if [[ -z "$URL" ]]; then
    print_error "‚ùå No URL provided. Exiting."
    exit 1
fi
echo ""

# Download type selection
print_responsive_box_line $TERMINAL_WIDTH "What to download?"
print_responsive_box_line $TERMINAL_WIDTH " 1 = Single video (ignores playlist params in URL)"
print_responsive_box_line $TERMINAL_WIDTH " 2 = Full playlist"
print_responsive_box_line $TERMINAL_WIDTH "Enter choice (1/2) [default=1]: " "left"
read -r TYPE_CHOICE || TYPE_CHOICE="1"
TYPE_CHOICE="${TYPE_CHOICE:-1}"
TYPE_CHOICE=$(echo "$TYPE_CHOICE" | xargs)

IS_PLAYLIST="false"
PLAYLIST_FLAG="--no-playlist"
OUTPUT_TEMPLATE="%(title)s.%(ext)s"

if [[ "$TYPE_CHOICE" == "2" ]]; then
    IS_PLAYLIST="true"
    PLAYLIST_FLAG="--yes-playlist"
    echo ""
    echo -e "\033[38;5;39m‚ÑπÔ∏è  Playlist mode: Will download ALL videos in playlist\033[0m"
else
    echo ""
    echo -e "\033[38;5;39m‚ÑπÔ∏è  Single video mode: Will download ONLY this video (ignores ?list= params)\033[0m"
fi
echo ""

# Format selection
print_responsive_box_line $TERMINAL_WIDTH "Download as:"
print_responsive_box_line $TERMINAL_WIDTH " 1 = Video (with audio)"
print_responsive_box_line $TERMINAL_WIDTH " 2 = MP3 (audio only)"
print_responsive_box_line $TERMINAL_WIDTH "Enter choice (1/2) [default=1]: " "left"
read -r FORMAT_CHOICE || FORMAT_CHOICE="1"
FORMAT_CHOICE="${FORMAT_CHOICE:-1}"
FORMAT_CHOICE=$(echo "$FORMAT_CHOICE" | xargs)

IS_MP3="false"
MP3_FLAGS=""
FORMAT="bestvideo+bestaudio/best"
AUDIO_QUAL="0"

if [[ "$FORMAT_CHOICE" == "2" ]]; then
    IS_MP3="true"
    MP3_FLAGS="-x --audio-format mp3"
    
    echo ""
    print_responsive_box_line $TERMINAL_WIDTH "MP3 quality options:"
    print_responsive_box_line $TERMINAL_WIDTH " 1 = Best (VBR ~320kbps)"
    print_responsive_box_line $TERMINAL_WIDTH " 2 = High (192kbps)"
    print_responsive_box_line $TERMINAL_WIDTH " 3 = Medium (128kbps)"
    print_responsive_box_line $TERMINAL_WIDTH "Enter choice (1-3) [default=1]: " "left"
    read -r QUAL_CHOICE || QUAL_CHOICE="1"
    QUAL_CHOICE="${QUAL_CHOICE:-1}"
    QUAL_CHOICE=$(echo "$QUAL_CHOICE" | xargs)
    
    case "$QUAL_CHOICE" in
        2) AUDIO_QUAL="192K" ;;
        3) AUDIO_QUAL="128K" ;;
        *) AUDIO_QUAL="0" ;;
    esac
    
    MP3_FLAGS="$MP3_FLAGS --audio-quality $AUDIO_QUAL"
    FORMAT="bestaudio"
fi
echo ""

# === ENHANCED QUALITY SELECTION ===
if [[ "$IS_MP3" == "false" ]]; then
    echo -e "\033[38;5;39müîç Fetching available qualities... (usually 2-5 seconds)\033[0m"
    
    ACTUAL_HEIGHTS=$(timeout 15 yt-dlp --cookies-from-browser chrome --no-playlist \
        --print "%(height)s" "$URL" 2>/dev/null | \
        grep -E '^[0-9]+$' | sort -nur | uniq | head -10 || echo "")
    
    STANDARD_HEIGHTS=(2160 1440 1080 720 480 360)
    DISPLAY_HEIGHTS=""
    
    if [[ -n "$ACTUAL_HEIGHTS" ]]; then
        for h in $ACTUAL_HEIGHTS; do
            if [[ " ${STANDARD_HEIGHTS[*]} " =~ " $h " ]]; then
                DISPLAY_HEIGHTS="$DISPLAY_HEIGHTS $h"
            fi
        done
        
        for std in "${STANDARD_HEIGHTS[@]}"; do
            if [[ ! " $DISPLAY_HEIGHTS " =~ " $std " ]]; then
                DISPLAY_HEIGHTS="$DISPLAY_HEIGHTS $std"
            fi
        done
    else
        DISPLAY_HEIGHTS="${STANDARD_HEIGHTS[*]}"
    fi
    
    DISPLAY_HEIGHTS=$(echo $DISPLAY_HEIGHTS | tr ' ' '\n' | sort -nur | uniq | tr '\n' ' ')
    
    echo -e "\033[38;5;46m‚úÖ Available standard qualities: $DISPLAY_HEIGHTS\033[0m"
    
    # Responsive prompt
    if [ "$TERMINAL_WIDTH" -ge 80 ]; then
        echo -n "Enter max height (e.g. 720, 1080) [default=720]: "
    else
        echo -n "Max height? (720/1080) [720]: "
    fi
    read -r MAX_HEIGHT || MAX_HEIGHT="720"
    MAX_HEIGHT="${MAX_HEIGHT:-720}"
    MAX_HEIGHT=$(echo "$MAX_HEIGHT" | xargs)
    
    if [[ ! " ${STANDARD_HEIGHTS[*]} " =~ " $MAX_HEIGHT " ]]; then
        print_error "‚ö†Ô∏è  Invalid height. Using default 720p."
        MAX_HEIGHT=720
    fi
    
    FORMAT="bestvideo[height<=${MAX_HEIGHT}][ext=mp4]+bestaudio[ext=m4a]/best[height<=${MAX_HEIGHT}][ext=mp4]/bestvideo[height<=${MAX_HEIGHT}]+bestaudio/best[height<=${MAX_HEIGHT}]"
else
    MAX_HEIGHT="N/A"
fi
echo ""

# Folder organization
FOLDER_NAME=""
USE_FOLDER="false"

if [[ "$IS_PLAYLIST" == "true" ]]; then
    if [ "$TERMINAL_WIDTH" -ge 80 ]; then
        print_responsive_box_line $TERMINAL_WIDTH "üìÅ Create dedicated folder for playlist? (HIGHLY RECOMMENDED)"
        print_responsive_box_line $TERMINAL_WIDTH "   Prevents mixing files from playlists with identical names"
        print_responsive_box_line $TERMINAL_WIDTH "   y = Yes (safe default) | n = No [default=y]: " "left"
    else
        echo "üìÅ Folder for playlist? (y/n) [y]: "
    fi
    read -r FOLDER_CHOICE || FOLDER_CHOICE="y"
    FOLDER_CHOICE="${FOLDER_CHOICE:-y}"
    FOLDER_CHOICE=$(echo "$FOLDER_CHOICE" | xargs | tr '[:upper:]' '[:lower:]')
    
    if [[ "${FOLDER_CHOICE}" == "y" || "${FOLDER_CHOICE}" == "" ]]; then
        USE_FOLDER="true"
        echo -n "Folder name? (blank for auto): "
        read -r FOLDER_NAME || FOLDER_NAME=""
        FOLDER_NAME=$(echo "$FOLDER_NAME" | xargs)
        FOLDER_NAME="${FOLDER_NAME:-%(playlist_title)s [%(playlist_id)s]}"
        OUTPUT_TEMPLATE="${FOLDER_NAME}/%(playlist_index)02d - %(title)s.%(ext)s"
    else
        OUTPUT_TEMPLATE="%(playlist_index)02d - %(title)s.%(ext)s"
    fi
else
    echo -n "üìÅ Save in custom folder? (y/n) [n]: "
    read -r FOLDER_CHOICE || FOLDER_CHOICE="n"
    FOLDER_CHOICE="${FOLDER_CHOICE:-n}"
    FOLDER_CHOICE=$(echo "$FOLDER_CHOICE" | xargs | tr '[:upper:]' '[:lower:]')
    
    if [[ "${FOLDER_CHOICE}" == "y" ]]; then
        USE_FOLDER="true"
        echo -n "Folder name: "
        read -r FOLDER_NAME || FOLDER_NAME="Downloads"
        FOLDER_NAME=$(echo "$FOLDER_NAME" | xargs)
        FOLDER_NAME="${FOLDER_NAME:-Downloads}"
        OUTPUT_TEMPLATE="${FOLDER_NAME}/%(title)s.%(ext)s"
    fi
fi
echo ""

# === BULLETPROOF ARCHIVE HANDLING ===
VIDEO_ID=""
if [[ "$URL" =~ (?:v=|youtu\.be/)([^&?/]{11}) ]]; then
    VIDEO_ID="${BASH_REMATCH[1]}"
elif [[ "$URL" =~ youtube\.com/embed/([^/?&]{11}) ]]; then
    VIDEO_ID="${BASH_REMATCH[1]}"
fi

ARCHIVE_FILE="$HOME/yt-downloads-archive.txt"
ARCHIVE_FLAG=""

if [[ "$IS_PLAYLIST" == "false" && -n "$VIDEO_ID" ]]; then
    touch "$ARCHIVE_FILE" 2>/dev/null || true
    
    if grep -qxF "$VIDEO_ID" "$ARCHIVE_FILE" 2>/dev/null; then
        print_error "‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  VIDEO ALREADY IN ARCHIVE  ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è"
        echo ""
        
        if [ "$TERMINAL_WIDTH" -ge 70 ]; then
            echo "   Video ID: $VIDEO_ID"
            echo "   ‚ö†Ô∏è  Archive only means yt-dlp *attempted* download before"
            echo "   ‚ö†Ô∏è  File might be MISSING or CORRUPTED!"
            echo ""
            echo "   Options:"
            echo "     y = YES ‚Üí Delete from archive + re-download"
            echo "     n = NO  ‚Üí Skip download (safe default)"
            echo -n "   Delete from archive and re-download? (y/N): "
        else
            echo "   Video: $VIDEO_ID"
            echo "   Already in archive!"
            echo ""
            echo "   y = Delete & redownload"
            echo "   n = Skip [default]"
            echo -n "   Choice? (y/N): "
        fi
        
        read -r CHOICE
        CHOICE=$(echo "${CHOICE:-n}" | tr '[:upper:]' '[:lower:]')
        echo ""
        
        if [[ "$CHOICE" == "y" ]]; then
            grep -vxF "$VIDEO_ID" "$ARCHIVE_FILE" > "${ARCHIVE_FILE}.tmp" 2>/dev/null || true
            mv "${ARCHIVE_FILE}.tmp" "$ARCHIVE_FILE" 2>/dev/null || true
            echo -e "\033[38;5;46m‚úÖ DELETED $VIDEO_ID from archive. Proceeding...\033[0m"
            echo ""
        else
            echo -e "\033[38;5;46m‚úÖ SKIPPED download per your choice.\033[0m"
            exit 0
        fi
    fi
fi

if [[ "$IS_PLAYLIST" == "true" ]]; then
    ARCHIVE_FLAG="--download-archive $ARCHIVE_FILE"
fi

# Responsive execution summary
echo -e "\033[38;5;39müöÄ STARTING DOWNLOAD\033[0m"
print_responsive_separator $TERMINAL_WIDTH

summary_width=$((TERMINAL_WIDTH < 60 ? 60 : TERMINAL_WIDTH))

if [ "$summary_width" -ge 70 ]; then
    print_responsive_box_line $summary_width "URL:          $(echo "$URL" | cut -c1-$((summary_width-20)))"
    print_responsive_box_line $summary_width "Type:         $( [[ "$IS_PLAYLIST" == "true" ]] && echo "Playlist (ALL videos)" || echo "Single Video ONLY" )"
    print_responsive_box_line $summary_width "Format:       $( [[ "$IS_MP3" == "true" ]] && echo "MP3 ($AUDIO_QUAL)" || echo "Video (max ${MAX_HEIGHT}p) WITH AUDIO" )"
    print_responsive_box_line $summary_width "Destination:  $( [[ "$USE_FOLDER" == "true" ]] && echo "$FOLDER_NAME" || echo "Current directory" )"
    print_responsive_box_line $summary_width "JS Runtime:   $( [[ -n "$JS_RUNTIME" ]] && echo "${JS_RUNTIME##*=}" || echo "None" )"
else
    print_responsive_box_line $summary_width "Type: $( [[ "$IS_PLAYLIST" == "true" ]] && echo "Playlist" || echo "Single" )"
    print_responsive_box_line $summary_width "Format: $( [[ "$IS_MP3" == "true" ]] && echo "MP3" || echo "Video ${MAX_HEIGHT}p" )"
    print_responsive_box_line $summary_width "Dest: $( [[ "$USE_FOLDER" == "true" ]] && echo "$FOLDER_NAME" || echo "Current" )"
fi

print_responsive_separator $TERMINAL_WIDTH
echo ""

# === FIXED yt-dlp COMMAND (WITH ANIMATED RETRIES) ===
DOWNLOAD_SUCCESS=false
for ATTEMPT in 1 2 3; do
    if yt-dlp \
        $PLAYLIST_FLAG \
        $MP3_FLAGS \
        -f "$FORMAT" \
        -o "$OUTPUT_TEMPLATE" \
        $JS_RUNTIME \
        --cookies-from-browser chrome \
        --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
        --ignore-errors \
        --continue \
        --no-overwrites \
        --merge-output-format mp4 \
        $ARCHIVE_FLAG \
        --progress \
        "$URL" 2>&1; then
        DOWNLOAD_SUCCESS=true
        break
    else
        echo ""
        if [[ $ATTEMPT -lt 3 ]]; then
            print_error "‚ö†Ô∏è  Attempt $ATTEMPT failed. Refreshing cookies..."
            pkill -f "chrome" 2>/dev/null || true
            sleep 3
            google-chrome-stable --no-startup-window 2>/dev/null &
            sleep 3
            pkill -f "chrome" 2>/dev/null || true
            echo -e "\033[38;5;39müîÑ Retrying (attempt $((ATTEMPT + 1))...\033[0m"
            sleep 2
        fi
    fi
done

if [[ "$DOWNLOAD_SUCCESS" == false ]]; then
    echo ""
    print_error "‚ùå DOWNLOAD FAILED AFTER 3 ATTEMPTS"
    
    if [ "$TERMINAL_WIDTH" -ge 70 ]; then
        echo "   üí° TANZANIA FIX:"
        echo "     1. Disconnect WiFi/Ethernet"
        echo "     2. Wait 10 seconds"
        echo "     3. Reconnect and retry"
    else
        echo "   üí° FIX:"
        echo "     1. Disconnect internet"
        echo "     2. Wait 10s"
        echo "     3. Reconnect"
    fi
    exit 1
fi

# === RESPONSIVE COMPLETION BOX ===
echo ""
print_responsive_separator $TERMINAL_WIDTH
print_responsive_box_line $TERMINAL_WIDTH "" "center"
print_responsive_box_line $TERMINAL_WIDTH "‚úÖ DOWNLOAD COMPLETE at $(date '+%I:%M:%S %p')" "center"
print_responsive_box_line $TERMINAL_WIDTH "" "center"

if [ "$TERMINAL_WIDTH" -ge 70 ]; then
    print_responsive_box_line $TERMINAL_WIDTH "Files saved: $( [[ "$USE_FOLDER" == "true" ]] && echo "$FOLDER_NAME" || echo "Current directory" )"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Mode: $( [[ "$IS_PLAYLIST" == "true" ]] && echo "FULL PLAYLIST" || echo "SINGLE VIDEO ONLY" )"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Audio: GUARANTEED (MP4 merge format)"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Quality: Standard resolutions (360p-4K) always available"
    print_responsive_box_line $TERMINAL_WIDTH "" "center"
    print_responsive_box_line $TERMINAL_WIDTH "üí° TANZANIA TIPS:" "center"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Single video? Script IGNORES ?list= params"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Audio missing? Re-download at 720p"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Bot errors? Script auto-refreshes cookies"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Slow network? 720p works 95% of time"
else
    print_responsive_box_line $TERMINAL_WIDTH "Saved: $( [[ "$USE_FOLDER" == "true" ]] && echo "$FOLDER_NAME" || echo "Here" )"
    print_responsive_box_line $TERMINAL_WIDTH "Mode: $( [[ "$IS_PLAYLIST" == "true" ]] && echo "Playlist" || echo "Single" )"
    print_responsive_box_line $TERMINAL_WIDTH "Audio: ‚úì Guaranteed"
    print_responsive_box_line $TERMINAL_WIDTH "" "center"
    print_responsive_box_line $TERMINAL_WIDTH "üí° TIPS:" "center"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Single? Ignores ?list= params"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Audio missing? Try 720p"
    print_responsive_box_line $TERMINAL_WIDTH "‚Ä¢ Slow network? Use 720p"
fi

print_responsive_box_line $TERMINAL_WIDTH "" "center"
print_responsive_box_line $TERMINAL_WIDTH "Enjoy your downloads! üåç‚ú®" "center"
print_responsive_box_line $TERMINAL_WIDTH "Made with ‚ù§Ô∏è for Tanzania by Johnbosco" "center"
print_responsive_box_line $TERMINAL_WIDTH "" "center"
print_responsive_box_bottom $TERMINAL_WIDTH
echo ""

# === RESPONSIVE SIGNATURE ===
echo -e "\033[38;5;194m\"Out here doing some Alien things, Jesus is King...\" ~johnboscocjt\033[0m"
echo -e "\033[38;5;82m"

if [ "$TERMINAL_WIDTH" -ge 100 ]; then
    cat << 'EOF'
                                    ¬∏¬∏,..--------------------.....,¬∏
                      ¬∏,..--¬∑¬∑ÀúÀú¬®¬®                                     ¬®¬®Àú¬∑.¬∏
                 ¬∏.¬∑Àú                                                          Àú¬∑¬∏
             ¬∏.¬∑Àú                                                          ¬∏Àú    Àú¬∏
         ¬∏¬∏¬∑''                                                           ¬∏ ¬∑  Àú¬∏  Àú
        ¬∏Àú¬®  ¬∏¬∏Àú                                                    ¬∏.¬∑Àú¬∏ ¬∑Àú
       ¬∏'     Àú¬∑¬∏                                         ¬∏,..--¬∑.¬∏
      ¬∏'¬∏¬∏¬∏      Àú-.¬∏                                 ¬∏,..---¬∑¬∑¬∑-¬∏Àú¬®¬∏
    ¬∑Àú¬∏¬∏¬∏¬∏¬∏¬∏¬Ø¬ØÀú¬∑.¬∏      .¬∏¬∑Àú                 ¬∏,-¬∑Àú;;;;;;;;;;;;¬∏'Àú
       ¬∏¬∑Àú ;;;;;;,Àú¬∑¬∏   Àú¬∏      Àú.¬∏          ¬∏.Àú;;;;;;;;;;;;;;;;¬∏'
      ';;;;;;;;;;;;;;;;¬∏¬∏ '¬∏       ¬¥      ¬∏¬∑';;;;;;;;;;;;;;;;; ¬∏¬¥
      ';;;;;;;;;;;;;;;;;;'¬∏ Àú¬∏         /¬∏/;;;;;;;;;;;;;;;; ¬∏.¬∑Àú ¬∏Àú       ¬∏Àú
       Àú¬∑.,¬∏¬∏¬∏.....----¬∑¬∏/        Àú-¬®ÀúÀúÀúÀúÀúÀúÀúÀú¬®¬®¬∏¬∏,.¬∑-'Àú               Àú¬∑¬∏¬∑Àú
           Àú¬Ø¬∏¬∏¬∏¬∏¬∏   ¬∏¬∑Àú   ¬∏¬∑    ¬¥  ¬Ø¬Ø¬Ø¬Ø¬Ø                        ¬∏¬∑'Àú
              Àú¬∑¬∏   ¬∑¬®¬∏¬∏,,,.Àú .,¬∏                               ¬∏,.¬∑Àú¬®
                  Àú¬®¬∏           ¬ØÀú¬∑¬∏              ¬∏.¬∑¬∑¬∑ÀúÀú¬∑¬∏.¬∑Àú¬®¬∏/
                     Àú¬∑¬∏¬∏¬∏,,,,¬∏¬∏¬∏¬∏   Àú¬∏         ¬∏¬∑Àú   ¬∏.¬∑Àú,Àú ¬∏¬∑Àú¬®
                        ¬∏¬®ÀúÀúÀú'Àú¬®¬®¬Ø'   Àú¬∏       Àú¬∏,.¬∑Àú¬∏;     \¬∏
                          Àú¬∏            Àú¬∏.   ¬∏¬∑Àú;;;Àú         '¬∏
                           Àú¬∏¬∏          ¬∏,.-¬∑¬®¬∏;;;              '¬∏
                          ¬∏,¬∑¬¥¬Ø¬®ÀúÀúÀú¬®¬Ø¬Ø;;;;;;;Àú                 Àú.,¬∏¬∏¬∏
  ;;;;;;;;;;;;;;;;;  ¬∏,.¬∑Àú;;;;;;;;;;;;;;;;;;;Àú                          Àú¬∑¬∏ ';;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  ;;
    ¬®¬®¬®¬®¬®¬®¬®¬®ÀúÀúÀúÀúÀúÀúÀúÀú''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''ÀúÀúÀúÀúÀúÀúÀúÀúÀúÀúÀú¬®
EOF
elif [ "$TERMINAL_WIDTH" -ge 60 ]; then
    cat << 'EOF'
            ,..------------------....,
     ,..--¬∑¬∑Àú¬®¬®               ¬®¬®Àú¬∑.¬∏
  ¬∏.¬∑Àú                              Àú¬∑¬∏
 ¬∏¬∑Àú                              ¬∏Àú   Àú¬∏
¬∑''                            ¬∏ ¬∑  Àú¬∏  Àú
¬®  ¬∏¬∏Àú                   ¬∏.¬∑Àú¬∏ ¬∑Àú
'     Àú¬∑¬∏          ¬∏,..--¬∑.¬∏
'¬∏¬∏¬∏      Àú-.¬∏  ¬∏,..---¬∑¬∑¬∑-¬∏Àú¬®¬∏
¬∑Àú¬∏¬∏¬∏¬∏¬∏¬∏¬Ø¬ØÀú¬∑.¬∏  ¬∏,-¬∑Àú;;;;;;¬∏'Àú
 ¬∏¬∑Àú ;;;;;;,Àú¬∑¬∏ ¬∏
