#!/usr/bin/env bash
# YutubuDownload - Tanzania-Optimized YouTube Downloader for Ubuntu Terminal
# Author: Johnbosco | Updated: February 10, 2026
# GitHub: https://github.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal
# Version: 1.0.3 — Single progress bar fix

set -euo pipefail

# === COLOR DEFINITIONS ===
RESET="\033[0m"
BLACK="\033[30m"
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
MAGENTA="\033[35m"
CYAN="\033[36m"
WHITE="\033[37m"
BRIGHT_RED="\033[91m"
BRIGHT_GREEN="\033[92m"
BRIGHT_YELLOW="\033[93m"
BRIGHT_BLUE="\033[94m"
BRIGHT_MAGENTA="\033[95m"
BRIGHT_CYAN="\033[96m"
BRIGHT_WHITE="\033[97m"
ORANGE="\033[38;5;214m"
PINK="\033[38;5;206m"
LIME="\033[38;5;46m"
SKY_BLUE="\033[38;5;39m"
HOT_PINK="\033[38;5;196m"

# === HELPER FUNCTION FOR PADDED COLORED OUTPUT ===
print_padded() {
    local label="$1"
    local colored_text="$2"
    local total_width=78
    local plain_text=$(echo -e "$colored_text" | sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g")
    local text_length=${#plain_text}
    local label_length=${#label}
    local total_length=$((label_length + text_length))
    local padding=$((total_width - total_length))
    printf "${BRIGHT_GREEN}║${RESET} ${CYAN}%s${RESET} %s%*s ${BRIGHT_GREEN}║${RESET}\n" "$label" "$colored_text" "$padding" ""
}

# === ANIMATED FEEDBACK FUNCTIONS ===
print_loading() {
    local msg="$1"
    echo -ne "${SKY_BLUE}$msg${RESET}"
    for _ in {1..5}; do
        echo -ne "."
        sleep 0.3
    done
    echo -e " ${BRIGHT_GREEN}✅${RESET}"
}

print_error() {
    local msg="$1"
    echo -ne "${HOT_PINK}$msg${RESET}"
    for _ in {1..3}; do
        echo -ne " ❗"
        sleep 0.2
    done
    echo -e " ${RED}❌${RESET}"
}

# Function to extract YouTube video ID from URL
extract_video_id() {
    local url="$1"
    local video_id=""
    if [[ "$url" =~ (?:v=|youtu\.be/)([^&?/]{11}) ]]; then
        video_id="${BASH_REMATCH[1]}"
    elif [[ "$url" =~ youtube\.com/embed/([^/?&]{11}) ]]; then
        video_id="${BASH_REMATCH[1]}"
    elif [[ "$url" =~ youtube\.com/watch\?.*v=([^&]{11}) ]]; then
        video_id="${BASH_REMATCH[1]}"
    fi
    echo "$video_id"
}

# Version check
if [[ "${1:-}" == "--version" ]] || [[ "${1:-}" == "-v" ]]; then
    echo "YutubuDownload v1.0.3 (2026-02-10) • Tanzania-Optimized • SINGLE PROGRESS BAR"
    exit 0
fi

# Force download option (kept for future use, but not needed now)
if [[ "${1:-}" == "--force-download" ]] || [[ "${1:-}" == "-f" ]]; then
    FORCE_DOWNLOAD="true"
    shift
else
    FORCE_DOWNLOAD="false"
fi

# === BADASS HACKER-STYLE GRADIENT BANNER ===
{
  echo -e "\033[38;5;51m▖▖  ▗   ▌   ▄        ▜      ▌"
  echo -e "\033[38;5;46m▌▌▌▌▜▘▌▌▛▌▌▌▌▌▛▌▌▌▌▛▌▐ ▛▌▀▌▛▌"
  echo -e "\033[38;5;39m▐ ▙▌▐▖▙▌▙▌▙▌▙▘▙▌▚▚▘▌▌▐▖▙▌█▌▙▌"
  echo -e "\033[0m"
} >/dev/tty 2>/dev/null || { echo "YutubuDownload"; }

# === CUSTOM HEADER ===
echo -e "${BRIGHT_CYAN}YutubeDownload, v1.0.3${RESET}"

# === SMART COOKIE REFRESH (Tanzania-optimized) ===
echo -e "${SKY_BLUE}🔄 Preparing Chrome cookies (Tanzania-optimized)...${RESET}"
pkill -f "chrome" 2>/dev/null || true
pkill -f "chromium" 2>/dev/null || true
pkill -f "crashpad" 2>/dev/null || true

print_loading "⏳ Unlocking cookies"

google-chrome-stable --no-startup-window 2>/dev/null &
CHROME_PID=$!
sleep 3
kill $CHROME_PID 2>/dev/null || true
wait $CHROME_PID 2>/dev/null || true
echo -e "${LIME}✅ Cookies refreshed in 8 seconds${RESET}"
echo ""

# === ROBUST DBUS SESSION SETUP ===
if [ -z "${DBUS_SESSION_BUS_ADDRESS+x}" ]; then
    for source in "gnome-session" "systemd" "dbus-daemon"; do
        PID=$(pgrep -u "$USER" -f "$source" 2>/dev/null | head -n1 || true)
        if [ -n "$PID" ] && [ -f "/proc/$PID/environ" ]; then
            export $(tr '\0' '\n' < "/proc/$PID/environ" 2>/dev/null | grep -m1 "^DBUS_SESSION_BUS_ADDRESS=" || echo "DBUS_SESSION_BUS_ADDRESS=disabled")
            break
        fi
    done
    if [ -z "${DBUS_SESSION_BUS_ADDRESS+x}" ]; then
        export DBUS_SESSION_BUS_ADDRESS=disabled
    fi
fi

# Activate virtual environment
VENV_PATH="$HOME/youtubedownloading/yt-venv/bin/activate"
if [ -f "$VENV_PATH" ]; then
    source "$VENV_PATH" 2>/dev/null || true
    echo -e "${LIME}✅ Activated virtual environment (yt-venv) for cookie decryption${RESET}"
else
    VENV_PATH="/root/youtubedownloading/yt-venv/bin/activate"
    if [ -f "$VENV_PATH" ]; then
        source "$VENV_PATH" 2>/dev/null || true
        echo -e "${LIME}✅ Activated system virtual environment (yt-venv)${RESET}"
    else
        print_error "⚠️  Warning: yt-venv not found at ~/youtubedownloading/yt-venv"
        echo "   Cookie decryption may fail. Run installer:"
        echo -e "   ${CYAN}sudo bash -c '\$(curl -sL https://raw.githubusercontent.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal/main/install.sh)'${RESET}"
    fi
fi
echo ""

# Dependency checks
if ! command -v yt-dlp &> /dev/null; then
    print_error "❌ ERROR: yt-dlp not found!"
    echo "   Install with installer:"
    echo -e "   ${CYAN}sudo bash -c '\$(curl -sL https://raw.githubusercontent.com/johnboscocjt/Youtube-Downloader-For-UbuntuTerminal/main/install.sh)'${RESET}"
    exit 1
fi

if ! command -v ffmpeg &> /dev/null; then
    print_error "⚠️  WARNING: ffmpeg missing → Videos will have NO AUDIO!"
    echo "   Install IMMEDIATELY:"
    echo -e "   ${CYAN}sudo apt install ffmpeg${RESET}"
    echo ""
fi

# Auto-detect JS runtime (Deno preferred)
JS_RUNTIME=""
if command -v deno &> /dev/null; then
    JS_RUNTIME="--js-runtimes deno"
    echo -e "${SKY_BLUE}⚡ Using Deno for YouTube JS challenges (recommended)${RESET}"
elif command -v node &> /dev/null; then
    JS_RUNTIME="--js-runtimes node"
    echo -e "${SKY_BLUE}⚡ Using Node.js for YouTube JS challenges${RESET}"
else
    print_error "⚠️  WARNING: No JS runtime found! YouTube may block high-quality downloads."
    echo "   Install Deno (recommended):"
    echo -e "   ${CYAN}curl -fsSL https://deno.land/install.sh | sh${RESET}"
fi
echo ""

# === USER INPUTS ===

# URL
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${BRIGHT_CYAN}📥 URL INPUT${RESET}"
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${CYAN}Enter YouTube URL (video or playlist):${RESET}"
echo -n -e "${BRIGHT_CYAN}> ${RESET}"
read -r URL || { echo ""; exit 1; }
URL=$(echo "$URL" | xargs)
[[ -z "$URL" ]] && { print_error "❌ No URL provided. Exiting."; exit 1; }
echo ""

# Download type
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${BRIGHT_CYAN}📋 DOWNLOAD TYPE${RESET}"
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${CYAN}What to download?${RESET}"
echo -e "  ${BRIGHT_BLUE}1${RESET} = Single video (ignores playlist params)"
echo -e "  ${BRIGHT_BLUE}2${RESET} = Full playlist"
echo -n -e "${BRIGHT_CYAN}Enter choice (1/2) [default=1]: ${RESET}"
read -r TYPE_CHOICE || TYPE_CHOICE="1"
TYPE_CHOICE="${TYPE_CHOICE:-1}"
TYPE_CHOICE=$(echo "$TYPE_CHOICE" | xargs)

IS_PLAYLIST="false"
PLAYLIST_FLAG="--no-playlist"
OUTPUT_TEMPLATE="%(title)s.%(ext)s"

if [[ "$TYPE_CHOICE" == "2" ]]; then
    IS_PLAYLIST="true"
    PLAYLIST_FLAG="--yes-playlist"
    echo -e "${SKY_BLUE}ℹ️  Playlist mode: Will download ALL videos in playlist${RESET}"
else
    echo -e "${SKY_BLUE}ℹ️  Single video mode: Will download ONLY this video${RESET}"
fi
echo ""

# Format
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${BRIGHT_CYAN}🎵 FORMAT SELECTION${RESET}"
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${CYAN}Download as:${RESET}"
echo -e "  ${BRIGHT_BLUE}1${RESET} = Video (with audio)"
echo -e "  ${BRIGHT_BLUE}2${RESET} = MP3 (audio only)"
echo -n -e "${BRIGHT_CYAN}Enter choice (1/2) [default=1]: ${RESET}"
read -r FORMAT_CHOICE || FORMAT_CHOICE="1"
FORMAT_CHOICE="${FORMAT_CHOICE:-1}"
FORMAT_CHOICE=$(echo "$FORMAT_CHOICE" | xargs)

IS_MP3="false"
MP3_FLAGS=""
FORMAT="bestvideo+bestaudio/best"
AUDIO_QUAL="0"

if [[ "$FORMAT_CHOICE" == "2" ]]; then
    IS_MP3="true"
    MP3_FLAGS="-x --audio-format mp3"
    echo ""
    echo -e "${CYAN}MP3 quality options:${RESET}"
    echo -e "  ${BRIGHT_BLUE}1${RESET} = Best (~320kbps)"
    echo -e "  ${BRIGHT_BLUE}2${RESET} = High (192kbps)"
    echo -e "  ${BRIGHT_BLUE}3${RESET} = Medium (128kbps)"
    echo -n -e "${BRIGHT_CYAN}Enter choice (1-3) [default=1]: ${RESET}"
    read -r QUAL_CHOICE || QUAL_CHOICE="1"
    QUAL_CHOICE="${QUAL_CHOICE:-1}"
    QUAL_CHOICE=$(echo "$QUAL_CHOICE" | xargs)
    case "$QUAL_CHOICE" in
        2) AUDIO_QUAL="192K" ;;
        3) AUDIO_QUAL="128K" ;;
        *) AUDIO_QUAL="0" ;;
    esac
    MP3_FLAGS="$MP3_FLAGS --audio-quality $AUDIO_QUAL"
    FORMAT="bestaudio"
fi
echo ""

# Quality (video only)
if [[ "$IS_MP3" == "false" ]]; then
    echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
    echo -e "${BRIGHT_CYAN}🎬 QUALITY SELECTION${RESET}"
    echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
    echo -e "${SKY_BLUE}🔍 Fetching available qualities...${RESET}"
    ACTUAL_HEIGHTS=$(timeout 15 yt-dlp --cookies-from-browser chrome --no-playlist \
        --print "%(height)s" "$URL" 2>/dev/null | \
        grep -E '^[0-9]+$' | sort -nur | uniq | head -n 10 || echo "")
    STANDARD_HEIGHTS=(2160 1440 1080 720 480 360)
    DISPLAY_HEIGHTS=""
    if [[ -n "$ACTUAL_HEIGHTS" ]]; then
        for h in $ACTUAL_HEIGHTS; do
            [[ " ${STANDARD_HEIGHTS[*]} " =~ " $h " ]] && DISPLAY_HEIGHTS="$DISPLAY_HEIGHTS $h"
        done
        for std in "${STANDARD_HEIGHTS[@]}"; do
            [[ ! " $DISPLAY_HEIGHTS " =~ " $std " ]] && DISPLAY_HEIGHTS="$DISPLAY_HEIGHTS $std"
        done
    else
        DISPLAY_HEIGHTS="${STANDARD_HEIGHTS[*]}"
    fi
    DISPLAY_HEIGHTS=$(echo $DISPLAY_HEIGHTS | tr ' ' '\n' | sort -nur | uniq | tr '\n' ' ')
    echo -e "${LIME}✅ Available standard qualities: $DISPLAY_HEIGHTS${RESET}"
    echo -n -e "${BRIGHT_CYAN}Enter max height (e.g. 720) [default=720]: ${RESET}"
    read -r MAX_HEIGHT || MAX_HEIGHT="720"
    MAX_HEIGHT="${MAX_HEIGHT:-720}"
    MAX_HEIGHT=$(echo "$MAX_HEIGHT" | xargs)
    if [[ ! " ${STANDARD_HEIGHTS[*]} " =~ " $MAX_HEIGHT " ]]; then
        print_error "⚠️  Invalid height. Using default 720p."
        MAX_HEIGHT=720
    fi
    FORMAT="bestvideo[height<=${MAX_HEIGHT}][ext=mp4]+bestaudio[ext=m4a]/best[height<=${MAX_HEIGHT}][ext=mp4]/bestvideo[height<=${MAX_HEIGHT}]+bestaudio/best[height<=${MAX_HEIGHT}]"
else
    MAX_HEIGHT="N/A"
fi
echo ""

# Folder
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${BRIGHT_CYAN}📁 FOLDER ORGANIZATION${RESET}"
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"

FOLDER_NAME=""
USE_FOLDER="false"

if [[ "$IS_PLAYLIST" == "true" ]]; then
    echo -e "${CYAN}Create dedicated folder for playlist? (HIGHLY RECOMMENDED)${RESET}"
    echo "   Prevents mixing files from playlists with identical names"
    echo -n -e "   ${BRIGHT_CYAN}y${RESET} = Yes (safe default) | ${BRIGHT_CYAN}n${RESET} = No [default=y]: "
    read -r FOLDER_CHOICE || FOLDER_CHOICE="y"
    FOLDER_CHOICE="${FOLDER_CHOICE:-y}"
    FOLDER_CHOICE=$(echo "$FOLDER_CHOICE" | tr '[:upper:]' '[:lower:]')
    if [[ "${FOLDER_CHOICE}" == "y" || "${FOLDER_CHOICE}" == "" ]]; then
        USE_FOLDER="true"
        echo -n -e "${BRIGHT_CYAN}Folder name? (leave blank for auto): ${RESET}"
        read -r FOLDER_NAME || FOLDER_NAME=""
        FOLDER_NAME=$(echo "$FOLDER_NAME" | xargs)
        FOLDER_NAME="${FOLDER_NAME:-%(playlist_title)s [%(playlist_id)s]}"
        OUTPUT_TEMPLATE="${FOLDER_NAME}/%(playlist_index)02d - %(title)s.%(ext)s"
    else
        OUTPUT_TEMPLATE="%(playlist_index)02d - %(title)s.%(ext)s"
    fi
else
    echo -n -e "${CYAN}Save in custom folder? (${BRIGHT_CYAN}y${RESET}/${BRIGHT_CYAN}n${RESET}) [default=n]: ${RESET}"
    read -r FOLDER_CHOICE || FOLDER_CHOICE="n"
    FOLDER_CHOICE="${FOLDER_CHOICE:-n}"
    FOLDER_CHOICE=$(echo "$FOLDER_CHOICE" | tr '[:upper:]' '[:lower:]')
    if [[ "${FOLDER_CHOICE}" == "y" ]]; then
        USE_FOLDER="true"
        echo -n -e "${BRIGHT_CYAN}Folder name (e.g. 'BongoFlava'): ${RESET}"
        read -r FOLDER_NAME || FOLDER_NAME="Downloads"
        FOLDER_NAME=$(echo "$FOLDER_NAME" | xargs)
        FOLDER_NAME="${FOLDER_NAME:-Downloads}"
        OUTPUT_TEMPLATE="${FOLDER_NAME}/%(title)s.%(ext)s"
    fi
fi
echo ""

# === DOWNLOAD SUMMARY ===
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${BRIGHT_CYAN}🚀 DOWNLOAD SUMMARY${RESET}"
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${CYAN}URL:${RESET}          $URL"
echo -e "${CYAN}Type:${RESET}         $( [[ "$IS_PLAYLIST" == "true" ]] && echo "${BRIGHT_GREEN}Playlist (ALL videos)${RESET}" || echo "${BRIGHT_BLUE}Single Video ONLY${RESET}" )"
echo -e "${CYAN}Format:${RESET}       $( [[ "$IS_MP3" == "true" ]] && echo "${BRIGHT_MAGENTA}MP3 ($AUDIO_QUAL)${RESET}" || echo "${BRIGHT_BLUE}Video (max ${MAX_HEIGHT}p) WITH AUDIO${RESET}" )"
echo -e "${CYAN}Destination:${RESET}  $( [[ "$USE_FOLDER" == "true" ]] && echo "${BRIGHT_YELLOW}$FOLDER_NAME${RESET}" || echo "${BRIGHT_YELLOW}Current directory${RESET}" )"
echo -e "${CYAN}JS Runtime:${RESET}   $( [[ -n "$JS_RUNTIME" ]] && echo "${BRIGHT_GREEN}${JS_RUNTIME##*=}${RESET}" || echo "${ORANGE}None${RESET}" )"
echo -e "${CYAN}Resume/Skip:${RESET}   ${BRIGHT_GREEN}File-based (auto-resume & skip)${RESET}"
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo ""

# === SINGLE PROGRESS BAR SETUP ===
BAR_WIDTH=20
CSI="\033["
HIDE_CURSOR="${CSI}?25l"
SHOW_CURSOR="${CSI}?25h"
CLEAR_LINE="${CSI}2K"
GOTO_COL1="${CSI}0G"

echo -e "$HIDE_CURSOR"
trap 'echo -e "${SHOW_CURSOR}\n"; exit' INT TERM EXIT

DISPLAY_LOCATION="${FOLDER_NAME:-Current directory}"

echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${BRIGHT_CYAN}📥 DOWNLOAD IN PROGRESS${RESET}"
echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${SKY_BLUE}Starting download... (single progress bar below)${RESET}"
echo ""

# === CORE yt-dlp COMMAND — NO ARCHIVE ===
DOWNLOAD_SUCCESS=false
CURRENT_ITEM=0
TOTAL_ITEMS=0

# Function to print metadata lines without interfering with progress bar
print_metadata() {
    local line="$1"
    if [[ "$line" =~ ^\[download\].*Downloading.*playlist ]] || \
       [[ "$line" =~ ^\[youtube\].*Extracting.*URL ]] || \
       [[ "$line" =~ ^\[download\].*Downloading.*item.*of ]]; then
        echo -e "${BRIGHT_CYAN}$line${RESET}"
    elif [[ "$line" =~ ^\[info\] ]]; then
        echo -e "${BLUE}$line${RESET}"
    elif [[ "$line" =~ ^\[ExtractAudio\] ]] || [[ "$line" =~ ^\[Merger\] ]]; then
        echo -e "${BRIGHT_GREEN}$line${RESET}"
    fi
}

# Function to update progress bar
update_progress() {
    local percent="$1"
    local downloaded="$2"
    local total="$3"
    local eta="$4"
    local speed="$5"
    local item_info="$6"
    
    percent_int="${percent%.*}"
    dl_mib=$(( downloaded / 1048576 ))
    tot_mib=$(( total / 1048576 ))
    
    # Build progress bar
    filled=$(( (percent_int * BAR_WIDTH) / 100 ))
    [ $filled -gt $BAR_WIDTH ] && filled=$BAR_WIDTH
    bar=$(printf '█%.0s' $(seq 1 "$filled"))
    empty=$(printf '░%.0s' $(seq 1 $((BAR_WIDTH - filled))))
    full_bar="$bar$empty"
    
    # Clear and update progress line
    echo -ne "${CLEAR_LINE}${GOTO_COL1}"
    
    # Different display for completed downloads
    if [ "$percent_int" -ge 99 ]; then
        printf "Downloading: ${GREEN}%s${RESET} ${BRIGHT_GREEN}100.0%%${RESET} ${BRIGHT_BLUE}[%dMiB/%dMiB]${RESET}" \
            "$full_bar" "$dl_mib" "$tot_mib"
    else
        printf "Downloading: ${GREEN}%s${RESET} ${YELLOW}%s${RESET} ${BRIGHT_BLUE}[%dMiB/%dMiB]${RESET}" \
            "$full_bar" "$percent" "$dl_mib" "$tot_mib"
    fi
    
    echo -ne "\n${CLEAR_LINE}${GOTO_COL1}"
    printf "ETA: ${YELLOW}%s${RESET} | Speed: ${CYAN}%s${RESET} | Location: ${MAGENTA}%s${RESET}" \
        "$eta" "$speed" "$DISPLAY_LOCATION"
    
    if [ -n "$item_info" ]; then
        echo -ne "\n${CLEAR_LINE}${GOTO_COL1}"
        printf "Item: ${BRIGHT_CYAN}%s${RESET}" "$item_info"
        echo -ne "\033[2A"  # Move cursor up 2 lines
    else
        echo -ne "\033[1A"  # Move cursor up 1 line
    fi
}

if yt-dlp \
    $PLAYLIST_FLAG \
    $MP3_FLAGS \
    -f "$FORMAT" \
    -o "$OUTPUT_TEMPLATE" \
    $JS_RUNTIME \
    --cookies-from-browser chrome \
    --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
    --ignore-errors \
    --continue \
    --no-overwrites \
    --merge-output-format mp4 \
    --newline \
    --no-warnings \
    --progress-template "download:%(progress.downloaded_bytes)s %(progress.total_bytes)s %(progress._percent_str)s %(progress._eta_str)s %(progress._speed_str)s" \
    --output-na-placeholder "-" \
    "$URL" 2>&1 | while IFS= read -r line; do

    # Parse progress lines
    if [[ "$line" =~ ^download:([0-9]+)\ ([0-9]+)\ ([0-9]+\.[0-9]+%?)\ ([0-9:-]*)\ (.*)$ ]]; then
        downloaded="${BASH_REMATCH[1]}"
        total="${BASH_REMATCH[2]}"
        percent="${BASH_REMATCH[3]}"
        eta="${BASH_REMATCH[4]}"
        speed="${BASH_REMATCH[5]}"
        
        item_info=""
        if [[ "$IS_PLAYLIST" == "true" ]] && [ $CURRENT_ITEM -gt 0 ]; then
            item_info="Item $CURRENT_ITEM of $TOTAL_ITEMS"
        fi
        
        update_progress "$percent" "$downloaded" "$total" "$eta" "$speed" "$item_info"
        continue
    fi
    
    # Parse playlist info
    if [[ "$line" =~ "Downloading.*item.*of.*([0-9]+)" ]]; then
        TOTAL_ITEMS="${BASH_REMATCH[1]}"
    fi
    
    if [[ "$line" =~ "Downloading item.*([0-9]+).*of" ]]; then
        CURRENT_ITEM="${BASH_REMATCH[1]}"
    fi
    
    # Print metadata lines
    print_metadata "$line"
    
done; then
    DOWNLOAD_SUCCESS=true
else
    EXIT_CODE=$?
    [[ $EXIT_CODE -ne 0 ]] && echo -e "\n${ORANGE}⚠️  Download exited with code $EXIT_CODE${RESET}"
fi

# Clean up cursor
echo -e "${SHOW_CURSOR}${CLEAR_LINE}${GOTO_COL1}\n"

if [[ "$DOWNLOAD_SUCCESS" == false ]]; then
    echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
    print_error "❌ DOWNLOAD FAILED"
    echo -e "${BRIGHT_MAGENTA}══════════════════════════════════════════════════════════════════════${RESET}"
    echo -e "${CYAN}   💡 TANZANIA FIX:${RESET}"
    echo -e "     1. Disconnect WiFi/Ethernet"
    echo -e "     2. Wait 10 seconds"
    echo -e "     3. Reconnect and retry"
    exit 1
fi

# === COMPLETION BOX ===
echo ""
echo -e "${BRIGHT_GREEN}╔══════════════════════════════════════════════════════════════════════════════╗${RESET}"
echo -e "${BRIGHT_GREEN}║${RESET}                                                                              ${BRIGHT_GREEN}║${RESET}"
printf "${BRIGHT_GREEN}║${RESET} ${BRIGHT_GREEN}✅ DOWNLOAD COMPLETE${RESET} at %-52s ${BRIGHT_GREEN}║${RESET}\n" "$(date '+%I:%M:%S %p')"
echo -e "${BRIGHT_GREEN}║${RESET}                                                                              ${BRIGHT_GREEN}║${RESET}"
FOLDER_DISPLAY="$( [[ "$USE_FOLDER" == "true" ]] && echo "$FOLDER_NAME" || echo "Current directory" )"
printf "${BRIGHT_GREEN}║${RESET} ${CYAN}Files saved:${RESET} %-63s ${BRIGHT_GREEN}║${RESET}\n" "$FOLDER_DISPLAY"
MODE_DISPLAY="$( [[ "$IS_PLAYLIST" == "true" ]] && echo "FULL PLAYLIST" || echo "SINGLE VIDEO ONLY" )"
printf "${BRIGHT_GREEN}║${RESET} ${CYAN}• Mode:${RESET} %-68s ${BRIGHT_GREEN}║${RESET}\n" "$MODE_DISPLAY"
printf "${BRIGHT_GREEN}║${RESET} ${CYAN}• Audio:${RESET} ${BRIGHT_GREEN}GUARANTEED${RESET} (MP4 merge format)                                       ${BRIGHT_GREEN}║${RESET}"
printf "\n${BRIGHT_GREEN}║${RESET} ${CYAN}• Quality:${RESET} ${BRIGHT_GREEN}Standard resolutions (360p-4K) always available${RESET}                   ${BRIGHT_GREEN}║${RESET}"
printf "\n${BRIGHT_GREEN}║${RESET} ${CYAN}• Resume:${RESET} ${BRIGHT_GREEN}Smart (partial = resume, full = skip)${RESET}                             ${BRIGHT_GREEN}║${RESET}"
echo -e "\n${BRIGHT_GREEN}║${RESET}                                                                              ${BRIGHT_GREEN}║${RESET}"
echo -e "${BRIGHT_GREEN}║${RESET}    ${BRIGHT_CYAN}💡 TANZANIA TIPS:${RESET}                                                         ${BRIGHT_GREEN}║${RESET}"
printf "${BRIGHT_GREEN}║${RESET} ${CYAN}•${RESET} Single video? Script ${BRIGHT_GREEN}IGNORES ?list= params${RESET}                                 ${BRIGHT_GREEN}║${RESET}"
printf "\n${BRIGHT_GREEN}║${RESET} ${CYAN}•${RESET} Audio missing? ${BRIGHT_YELLOW}Re-download at 720p${RESET} (most reliable streams)                 ${BRIGHT_GREEN}║${RESET}"
printf "\n${BRIGHT_GREEN}║${RESET} ${CYAN}•${RESET} Bot errors? Script ${BRIGHT_GREEN}auto-refreshes cookies${RESET}                                  ${BRIGHT_GREEN}║${RESET}"
printf "\n${BRIGHT_GREEN}║${RESET} ${CYAN}•${RESET} Slow network? ${BRIGHT_YELLOW}720p works 95% of time on Vodacom/Airtel${RESET}                       ${BRIGHT_GREEN}║${RESET}"
printf "\n${BRIGHT_GREEN}║${RESET} ${CYAN}• Re-download?${RESET} ${BRIGHT_YELLOW}Just delete the file and run again!${RESET}                          ${BRIGHT_GREEN}║${RESET}"
echo -e "\n${BRIGHT_GREEN}║${RESET}                                                                              ${BRIGHT_GREEN}║${RESET}"
printf "${BRIGHT_GREEN}║${RESET} ${BRIGHT_MAGENTA}Enjoy your downloads! 🌍✨${RESET}                                                   ${BRIGHT_GREEN}║${RESET}"
printf "\n${BRIGHT_GREEN}║${RESET} ${CYAN}Made with ❤️  for Tanzania by Johnbosco (Dar es Salaam)${RESET}                       ${BRIGHT_GREEN}║${RESET}"
echo -e "\n${BRIGHT_GREEN}║${RESET}                                                                              ${BRIGHT_GREEN}║${RESET}"
echo -e "${BRIGHT_GREEN}╚══════════════════════════════════════════════════════════════════════════════╝${RESET}"
echo ""

# === SIGNATURE ===
echo -e "\033[38;5;194m\"Out here doing some Alien things, Jesus is King...\" ~johnboscocjt (Isaiah 28:21)\033[0m"
echo -e "\033[38;5;82m"
cat << 'EOF'
                                    ¸¸,..--------------------.....,¸
                      ¸,..--··˜˜¨¨                                     ¨¨˜·.¸
                 ¸.·˜                                                          ˜·¸
             ¸.·˜                                                          ¸˜    ˜¸
         ¸¸·''                                                           ¸ ·  ˜¸  ˜
        ¸˜¨  ¸¸˜                                                    ¸.·˜¸ ·˜
       ¸'     ˜·¸                                         ¸,..--·.¸

      ¸'¸¸¸      ˜-.¸                                 ¸,..---···-¸˜¨¸
    ·˜¸¸¸¸¸¸¯¯˜·.¸      .¸·˜                 ¸,-·˜;;;;;;;;;;;;¸'˜
       ¸·˜ ;;;;;;,˜·¸   ˜¸      ˜.¸          ¸.˜;;;;;;;;;;;;;;;;¸'
      ';;;;;;;;;;;;;;;;¸¸ '¸       ´      ¸·';;;;;;;;;;;;;;;;; ¸´
      ';;;;;;;;;;;;;;;;;;'¸ ˜¸         /¸/;;;;;;;;;;;;;;;; ¸.·˜ ¸˜       ¸˜
       ˜·.,¸¸¸.....----·¸/        ˜-¨˜˜˜˜˜˜˜˜¨¨¸¸,.·-'˜               ˜·¸·˜
           ˜¯¸¸¸¸¸   ¸·˜   ¸·    ´  ¯¯¯¯¯                        ¸·'˜
              ˜·¸   ·¨¸¸,,,.˜ .,¸                               ¸,.·˜¨
                  ˜¨¸           ¯˜·¸              ¸.···˜˜·¸.·˜¨¸/
                     ˜·¸¸¸,,,,¸¸¸¸   ˜¸         ¸·˜   ¸.·˜,˜ ¸·˜¨
                        ¨¸¨˜˜˜'˜¨¨¯'   ˜¸       ˜¸,.·˜¸;     \¸
                          ˜¸            ˜¸.   ¸·˜;;;˜         '¸
                           ˜¸¸          ¸,.-·¨¸;;;              '¸
                          ¸,·´¯¨˜˜˜¨¯¯;;;;;;;˜                 ˜.,¸¸¸
  ;;;;;;;;;;;;;;;;;  ¸,.·˜;;;;;;;;;;;;;;;;;;;˜                          ˜·¸ ';;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  ;;
    ¨¨¨¨¨¨¨¨˜˜˜˜˜˜˜˜''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''˜˜˜˜˜˜˜˜˜˜˜¨
EOF
echo -e "\033[0m"
